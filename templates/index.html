{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-4">
  <div>
    <h3 class="m-0">Tableau de bord</h3>
    <p class="text-muted mb-0">Un aperçu rapide de votre cave à vin</p>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('wines.add_wine') }}" class="btn btn-dark">
      <i class="bi bi-plus-lg me-1"></i> Ajouter une bouteille
    </a>
    <a href="{{ url_for('search.search_wines') }}" class="btn btn-outline-secondary">
      <i class="bi bi-box-arrow-up-right me-1"></i> Consommer une bouteille
    </a>
  </div>
</div>

{% if not cellars %}
<div class="alert alert-warning">
  Vous n'avez pas encore de cave. <a href="{{ url_for('cellars.add_cellar') }}" class="alert-link">Créez-en une</a>
  pour commencer à ajouter des bouteilles.
</div>
{% endif %}

<div class="row g-3 mb-4">
  <div class="col-md-6 col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase fw-semibold">Nombre de bouteilles</h6>
        <p class="display-6 fw-bold mb-0">{{ total_bottles }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h6 class="text-muted text-uppercase fw-semibold">Valeur estimée de la cave</h6>
        {% if estimated_value_display %}
        <p class="display-6 fw-bold mb-0">{{ estimated_value_display }}&nbsp;€</p>
        {% else %}
        <p class="display-6 fw-bold mb-0 text-muted">—</p>
        <p class="text-muted small mb-0">Ajoutez des estimations de prix dans les fiches vins pour obtenir cette valeur.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">À consommer en priorité</h5>
          <small class="text-muted">Basé sur les informations de garde et l'âge du millésime</small>
        </div>
        <a href="{{ url_for('search.wines_to_consume') }}" class="btn btn-sm btn-outline-secondary" title="Voir tous les alcools à consommer">
          <i class="bi bi-plus-lg"></i>
        </a>
      </div>
      <div class="card-body">
        {% if wines_to_consume_preview %}
          {% for item in wines_to_consume_preview %}
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">{{ item.wine.name }}{% if item.wine.year %} — {{ item.wine.year }}{% endif %}</h6>
                <div class="text-muted small">
                  {{ item.wine.cellar.name if item.wine.cellar else 'Sans cave' }}
                  {% if item.wine.subcategory %}
                    · {{ item.wine.subcategory.name }}
                  {% endif %}
                </div>
              </div>
              <span class="badge rounded-pill text-bg-danger">Urgence {{ item.urgency_score|round(0) }}%</span>
            </div>
            <div class="progress my-2" style="height: 6px;">
              <div class="progress-bar bg-danger" role="progressbar" style="width: {{ [item.urgency_score, 100]|min }}%" aria-valuenow="{{ item.urgency_score|round(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            {% if item.garde_info %}
            <p class="small text-muted mb-0">
              {{ item.garde_info }}
            </p>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <p class="text-muted mb-0">Aucune recommandation immédiate. Ajoutez des informations de garde pour vos bouteilles afin d'obtenir des conseils personnalisés.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white">
        <h5 class="mb-0">Derniers ajouts en cave</h5>
      </div>
      <div class="card-body">
        {% if recent_wines %}
          <div class="list-group list-group-flush">
            {% for wine in recent_wines %}
            <a href="{{ url_for('wines.wine_detail', wine_id=wine.id) }}" class="list-group-item list-group-item-action py-3">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ wine.name }}{% if wine.year %} — {{ wine.year }}{% endif %}</h6>
                <small class="text-muted">{{ wine.cellar.name if wine.cellar else 'Sans cave' }}</small>
              </div>
              <p class="mb-1 text-muted small">
                {% if wine.subcategory %}
                  <span class="badge me-1" style="{{ wine.subcategory|subcategory_badge_style }}">{{ wine.subcategory.name }}</span>
                {% else %}
                  <span class="badge bg-secondary me-1">Non catégorisé</span>
                {% endif %}
                {% if wine.region %}{{ wine.region }}{% else %}Région inconnue{% endif %}
              </p>
              <small class="text-muted">Quantité : {{ wine.quantity }}</small>
            </a>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">Ajoutez votre première bouteille pour voir vos ajouts récents.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
