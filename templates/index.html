{% extends "base.html" %}
{% block extra_head %}
<style>
  /* Cartes de statistiques */
  .stat-card {
    background-color: var(--bg-card);
    border-radius: var(--radius-xl);
    padding: var(--spacing-xl);
    box-shadow: 0 4px 6px -1px var(--shadow-color), 0 10px 20px -5px var(--shadow-color);
    transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    height: 100%;
  }
  
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px -8px var(--shadow-hover);
  }
  
  .stat-card-label {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-sm);
  }
  
  .stat-card-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.1;
  }
  
  .stat-card-hint {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: var(--spacing-sm);
  }
  
  /* Section cards */
  .section-card {
    background-color: var(--bg-card);
    border-radius: var(--radius-xl);
    box-shadow: 0 4px 6px -1px var(--shadow-color), 0 10px 20px -5px var(--shadow-color);
    overflow: hidden;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .section-card-header {
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--spacing-md);
  }
  
  .section-card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }
  
  .section-card-subtitle {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 2px;
  }
  
  .section-card-body {
    padding: var(--spacing-lg);
    flex: 1;
  }
  
  /* Items de vin √† consommer */
  .consume-item {
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid var(--border-color);
  }
  
  .consume-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .consume-item:first-child {
    padding-top: 0;
  }
  
  .consume-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
  }
  
  .consume-item-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }
  
  .consume-item-meta {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 2px;
  }
  
  .consume-item-badge {
    padding: 0.35rem 0.75rem;
    border-radius: var(--radius-lg);
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
  }
  
  .consume-item-badge.urgent {
    background-color: var(--accent-danger);
    color: #fff;
  }
  
  .consume-item-badge.priority {
    background-color: var(--accent-warning);
    color: #1d1d1f;
  }
  
  .consume-item-progress {
    height: 6px;
    background-color: var(--bg-hover);
    border-radius: var(--radius-sm);
    overflow: hidden;
    margin: var(--spacing-sm) 0;
  }
  
  .consume-item-progress-fill {
    height: 100%;
    border-radius: var(--radius-sm);
    transition: width var(--transition-normal);
  }
  
  .consume-item-info {
    font-size: 0.8rem;
    color: var(--text-muted);
    line-height: 1.4;
  }
  
  /* Liste des derniers ajouts */
  .recent-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    margin: 0 calc(-1 * var(--spacing-md));
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    transition: background-color var(--transition-fast);
  }
  
  .recent-item:hover {
    background-color: var(--bg-hover);
    color: inherit;
  }
  
  .recent-item-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-light));
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 1.25rem;
    font-weight: 700;
    flex-shrink: 0;
  }
  
  .recent-item-content {
    flex: 1;
    min-width: 0;
  }
  
  .recent-item-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .recent-item-meta {
    font-size: 0.8rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
    margin-top: 2px;
  }
  
  .recent-item-cellar {
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
  }
  
  /* Bouton d'action header */
  .btn-section-action {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-md);
    border: 1.5px solid var(--border-color);
    background-color: var(--bg-card);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
  }
  
  .btn-section-action:hover {
    background-color: var(--bg-hover);
    border-color: var(--text-muted);
    color: var(--text-primary);
  }
  
  /* Empty state */
  .empty-state {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--text-muted);
  }
  
  .empty-state-icon {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-md);
    opacity: 0.5;
  }
  
  .empty-state-text {
    font-size: 0.9rem;
    line-height: 1.5;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-4">
  <div>
    <h3 class="m-0">Tableau de bord</h3>
    <p class="text-muted mb-0">Un aper√ßu rapide de votre cave √† vin</p>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('wines.add_wine') }}" class="btn btn-dark">
      <i class="bi bi-plus-lg me-1"></i> Ajouter une bouteille
    </a>
    <a href="{{ url_for('search.search_wines') }}" class="btn btn-outline-secondary">
      <i class="bi bi-box-arrow-up-right me-1"></i> Consommer une bouteille
    </a>
  </div>
</div>

{% if not cellars %}
<div class="alert alert-warning">
  Vous n'avez pas encore de cave. <a href="{{ url_for('cellars.add_cellar') }}" class="alert-link">Cr√©ez-en une</a>
  pour commencer √† ajouter des bouteilles.
</div>
{% endif %}

<!-- Statistiques -->
<div class="row g-4 mb-4">
  <div class="col-md-6 col-lg-3">
    <div class="stat-card">
      <div class="stat-card-label">Nombre de bouteilles</div>
      <div class="stat-card-value">{{ total_bottles }}</div>
    </div>
  </div>
  <div class="col-md-6 col-lg-3">
    <div class="stat-card">
      <div class="stat-card-label">Valeur estim√©e de la cave</div>
      {% if estimated_value_display %}
      <div class="stat-card-value">{{ estimated_value_display }}&nbsp;‚Ç¨</div>
      {% else %}
      <div class="stat-card-value" style="color: var(--text-muted);">‚Äî</div>
      <div class="stat-card-hint">Ajoutez des estimations de prix pour obtenir cette valeur.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Sections principales -->
<div class="row g-4">
  <!-- √Ä consommer en priorit√© -->
  <div class="col-lg-6">
    <div class="section-card">
      <div class="section-card-header">
        <div>
          <h5 class="section-card-title">√Ä consommer en priorit√©</h5>
          <div class="section-card-subtitle">Bas√© sur les informations de garde et l'√¢ge du mill√©sime</div>
        </div>
        <a href="{{ url_for('search.wines_to_consume') }}" class="btn-section-action" title="Voir tous les alcools √† consommer">
          <i class="bi bi-arrow-right"></i>
        </a>
      </div>
      <div class="section-card-body">
        {% if wines_to_consume_preview %}
          {% for item in wines_to_consume_preview %}
          <div class="consume-item">
            <div class="consume-item-header">
              <div>
                <h6 class="consume-item-title">{{ item.wine.name }}{% if item.wine.extra_attributes.year %} ‚Äî {{ item.wine.extra_attributes.year }}{% endif %}</h6>
                <div class="consume-item-meta">
                  {{ item.wine.cellar.name if item.wine.cellar else 'Sans cave' }}
                  {% if item.wine.subcategory %}
                    ¬∑ {{ item.wine.subcategory.name }}
                  {% endif %}
                </div>
              </div>
              <span class="consume-item-badge {% if item.urgency_score >= 80 %}urgent{% else %}priority{% endif %}">
                Urgence {{ item.urgency_score|round(0) }}%
              </span>
            </div>
            <div class="consume-item-progress">
              <div class="consume-item-progress-fill {% if item.urgency_score >= 80 %}bg-danger{% elif item.urgency_score >= 50 %}bg-warning{% else %}bg-success{% endif %}" 
                   style="width: {{ [item.urgency_score, 100]|min }}%"></div>
            </div>
            {% if item.garde_info %}
            <p class="consume-item-info">{{ item.garde_info }}</p>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">üç∑</div>
            <p class="empty-state-text">Aucune recommandation imm√©diate.<br>Ajoutez des informations de garde pour vos bouteilles afin d'obtenir des conseils personnalis√©s.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Derniers ajouts -->
  <div class="col-lg-6">
    <div class="section-card">
      <div class="section-card-header">
        <div>
          <h5 class="section-card-title">Derniers ajouts en cave</h5>
        </div>
      </div>
      <div class="section-card-body">
        {% if recent_wines %}
          {% for wine in recent_wines %}
          <a href="{{ url_for('wines.wine_detail', wine_id=wine.id) }}" class="recent-item">
            <div class="recent-item-icon">{{ wine.name[:1] }}</div>
            <div class="recent-item-content">
              <h6 class="recent-item-title">{{ wine.name }}{% if wine.extra_attributes.year %} ‚Äî {{ wine.extra_attributes.year }}{% endif %}</h6>
              <div class="recent-item-meta">
                {% if wine.subcategory %}
                  <span class="badge" style="{{ wine.subcategory|subcategory_badge_style }}">{{ wine.subcategory.name }}</span>
                {% else %}
                  <span class="badge" style="background-color: var(--text-muted); color: #fff;">Non cat√©goris√©</span>
                {% endif %}
                <span>{{ wine.extra_attributes.region or 'R√©gion inconnue' }}</span>
                <span>Qt√©: {{ wine.quantity }}</span>
              </div>
            </div>
            <span class="recent-item-cellar">{{ wine.cellar.name if wine.cellar else 'Sans cave' }}</span>
          </a>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <p class="empty-state-text">Ajoutez votre premi√®re bouteille pour voir vos ajouts r√©cents.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
