{% extends "base.html" %}

{% block title %}Paramètres OpenAI - Cave à Vin{% endblock %}

{% block content %}
<style>
  .settings-card {
    background: var(--card-bg, #fff);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
  }
  .settings-card-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-color, #e9ecef);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .settings-card-header h5 {
    margin: 0;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .settings-card-body {
    padding: 1.5rem;
  }
  .key-status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
  }
  .key-status.active {
    background: rgba(25, 135, 84, 0.1);
    color: #198754;
  }
  .key-status.inactive {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .stat-card {
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
  }
  .stat-card .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color, #6f42c1);
  }
  .stat-card .stat-label {
    font-size: 0.75rem;
    color: var(--text-muted, #6c757d);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .api-key-input {
    font-family: monospace;
    letter-spacing: 1px;
  }
  .info-box {
    background: rgba(13, 110, 253, 0.1);
    border-left: 4px solid #0d6efd;
    padding: 1rem;
    border-radius: 0 8px 8px 0;
    margin-bottom: 1.5rem;
  }
  .info-box h6 {
    margin: 0 0 0.5rem 0;
    color: #0d6efd;
    font-weight: 600;
  }
  .info-box p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--text-color, #212529);
  }
  .recent-calls-table {
    font-size: 0.875rem;
  }
  .recent-calls-table th {
    font-weight: 600;
    background: var(--bg-secondary, #f8f9fa);
  }
  .call-type-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .call-type-badge.wine_enrichment {
    background: rgba(111, 66, 193, 0.1);
    color: #6f42c1;
  }
  .call-type-badge.wine_pairing {
    background: rgba(13, 110, 253, 0.1);
    color: #0d6efd;
  }
  .call-type-badge.image_generation {
    background: rgba(25, 135, 84, 0.1);
    color: #198754;
  }
  .source-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .source-badge.user {
    background: rgba(25, 135, 84, 0.1);
    color: #198754;
  }
  .source-badge.global {
    background: rgba(13, 110, 253, 0.1);
    color: #0d6efd;
  }
  .source-badge.env {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
  }
</style>

<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-4">
  <div>
    <h2 class="mb-1">
      <i class="bi bi-gear me-2"></i>Paramètres OpenAI
    </h2>
    <p class="text-muted mb-0">Gérez votre clé API OpenAI personnelle</p>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('auth.my_consumption') }}" class="btn btn-primary">
      <i class="bi bi-graph-up me-1"></i>Ma consommation
    </a>
    <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>Retour
    </a>
  </div>
</div>

<!-- Info Box -->
<div class="info-box">
  <h6><i class="bi bi-info-circle me-1"></i>À propos des clés API</h6>
  <p>
    Par défaut, l'application utilise une clé API OpenAI globale configurée par l'administrateur.
    Vous pouvez configurer votre propre clé API pour utiliser votre propre quota OpenAI.
    Si vous configurez une clé personnelle, elle sera utilisée en priorité pour vos requêtes IA.
  </p>
</div>

<!-- Statut actuel -->
<div class="settings-card">
  <div class="settings-card-header">
    <h5><i class="bi bi-key"></i>Clé API personnelle</h5>
    {% if has_custom_key %}
    <span class="key-status active">
      <i class="bi bi-check-circle-fill"></i>Clé personnelle active
    </span>
    {% else %}
    <span class="key-status inactive">
      <i class="bi bi-dash-circle"></i>Clé globale utilisée
    </span>
    {% endif %}
  </div>
  <div class="settings-card-body">
    {% if has_custom_key %}
    <div class="alert alert-success mb-4">
      <i class="bi bi-check-circle me-2"></i>
      Vous avez configuré une clé API personnelle. Vos requêtes IA utilisent votre propre quota OpenAI.
    </div>
    
    <div class="d-flex gap-2 mb-4">
      <form method="POST" action="{{ url_for('auth.test_openai_key') }}" class="d-inline">
        <button type="submit" class="btn btn-outline-primary">
          <i class="bi bi-lightning me-1"></i>Tester la connexion
        </button>
      </form>
      <form method="POST" action="{{ url_for('auth.openai_settings') }}" class="d-inline" 
            onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer votre clé API personnelle ?');">
        <input type="hidden" name="action" value="delete">
        <button type="submit" class="btn btn-outline-danger">
          <i class="bi bi-trash me-1"></i>Supprimer ma clé
        </button>
      </form>
    </div>
    
    <hr>
    
    <h6 class="mb-3">Remplacer la clé actuelle</h6>
    {% endif %}
    
    <form method="POST" action="{{ url_for('auth.openai_settings') }}">
      <input type="hidden" name="action" value="save">
      
      <div class="mb-3">
        <label for="api_key" class="form-label">Clé API OpenAI</label>
        <input type="password" class="form-control api-key-input" id="api_key" name="api_key"
               placeholder="sk-..." autocomplete="off">
        <div class="form-text">
          Obtenez votre clé API sur <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-save me-1"></i>
        {% if has_custom_key %}Mettre à jour{% else %}Enregistrer{% endif %} la clé
      </button>
    </form>
  </div>
</div>

<!-- Statistiques d'utilisation -->
<div class="settings-card">
  <div class="settings-card-header">
    <h5><i class="bi bi-graph-up"></i>Utilisation ce mois-ci</h5>
  </div>
  <div class="settings-card-body">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">{{ monthly_stats.total_calls or 0 }}</div>
        <div class="stat-label">Appels IA</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ "{:,}".format(monthly_stats.total_input_tokens or 0).replace(",", " ") }}</div>
        <div class="stat-label">Tokens entrée</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ "{:,}".format(monthly_stats.total_output_tokens or 0).replace(",", " ") }}</div>
        <div class="stat-label">Tokens sortie</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${{ "%.4f"|format(monthly_stats.total_cost or 0) }}</div>
        <div class="stat-label">Coût estimé</div>
      </div>
    </div>
  </div>
</div>

<!-- Derniers appels -->
{% if recent_calls %}
<div class="settings-card">
  <div class="settings-card-header">
    <h5><i class="bi bi-clock-history"></i>Derniers appels</h5>
  </div>
  <div class="settings-card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover recent-calls-table mb-0">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Modèle</th>
            <th>Source</th>
            <th>Tokens</th>
            <th>Coût</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          {% for call in recent_calls %}
          <tr>
            <td>{{ call.created_at.strftime('%d/%m %H:%M') }}</td>
            <td>
              <span class="call-type-badge {{ call.call_type }}">
                {% if call.call_type == 'wine_enrichment' %}
                  <i class="bi bi-stars"></i> Enrichissement
                {% elif call.call_type == 'wine_pairing' %}
                  <i class="bi bi-cup-straw"></i> Accord
                {% elif call.call_type == 'image_generation' %}
                  <i class="bi bi-image"></i> Image
                {% else %}
                  {{ call.call_type }}
                {% endif %}
              </span>
            </td>
            <td><code>{{ call.model }}</code></td>
            <td>
              <span class="source-badge {{ call.api_key_source }}">
                {% if call.api_key_source == 'user' %}
                  <i class="bi bi-person"></i> Perso
                {% elif call.api_key_source == 'global' %}
                  <i class="bi bi-globe"></i> Global
                {% else %}
                  <i class="bi bi-terminal"></i> Env
                {% endif %}
              </span>
            </td>
            <td>{{ (call.input_tokens or 0) + (call.output_tokens or 0) }}</td>
            <td>${{ "%.4f"|format(call.estimated_cost or 0) }}</td>
            <td>
              {% if call.success %}
              <span class="badge bg-success">OK</span>
              {% else %}
              <span class="badge bg-danger">Erreur</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
