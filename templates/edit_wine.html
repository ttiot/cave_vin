{% extends "base.html" %}
{% block content %}
{% set form_data = form_data or {} %}
{% set raw_cellar = form_data.get('cellar_id') %}
{% if raw_cellar %}
  {% set current_cellar_id = raw_cellar|int %}
{% else %}
  {% set current_cellar_id = wine.cellar_id %}
{% endif %}
{% set raw_subcategory = form_data.get('subcategory_id') %}
{% if raw_subcategory %}
  {% set current_subcategory_id = raw_subcategory|int %}
{% else %}
  {% set current_subcategory_id = selected_subcategory_id %}
{% endif %}

<h3>Modifier "{{ wine.name }}"</h3>
<form method="POST">
  <div class="mb-3">
    <label class="form-label">Cave</label>
    <select class="form-select" name="cellar_id" required>
      {% for cellar in cellars %}
      <option value="{{ cellar.id }}" {% if current_cellar_id==cellar.id %}selected{% endif %}>
        {{ cellar.name }}{% if cellar.category %} — {{ cellar.category.name }}{% endif %}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Type d'alcool</label>
    <select class="form-select" name="subcategory_id" id="subcategory_id">
      <option value="" {% if not current_subcategory_id %}selected{% endif %}>Non spécifié</option>
      {% for category in categories %}
        <optgroup label="{{ category.name }}">
          {% for subcategory in category.subcategories %}
            <option value="{{ subcategory.id }}" {% if current_subcategory_id==subcategory.id %}selected{% endif %}>{{ subcategory.name }}</option>
          {% endfor %}
        </optgroup>
      {% endfor %}
    </select>
    <div class="form-text">Sélectionnez le type d'alcool (vin rouge, rhum ambré, etc.)</div>
  </div>
  <div class="mb-3">
    <label class="form-label">Nom</label>
    <input type="text" class="form-control" name="name" value="{{ form_data.get('name', wine.name) }}" required>
  </div>
  <div class="row">
    <div class="col-md-6 mb-3" data-field="region">
      <label class="form-label">Région</label>
      <input type="text" class="form-control" name="region" value="{{ form_data.get('region', wine.region or '') }}">
    </div>
    <div class="col-md-6 mb-3" data-field="grape">
      <label class="form-label">Cépage</label>
      <input type="text" class="form-control" name="grape" value="{{ form_data.get('grape', wine.grape or '') }}">
    </div>
  </div>
  <div class="row">
    <div class="col-md-3 mb-3" data-field="year">
      <label class="form-label">Année</label>
      <input type="number" class="form-control" name="year" value="{{ form_data.get('year', wine.year or '') }}" min="1900" max="2100">
    </div>
    <div class="col-md-3 mb-3" data-field="volume_ml">
      <label class="form-label">Contenance (mL)</label>
      <input type="number" class="form-control" name="volume_ml" min="10" step="10" value="{{ form_data.get('volume_ml', wine.volume_ml or '') }}">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Quantité</label>
      <input type="number" class="form-control" name="quantity" value="{{ form_data.get('quantity', wine.quantity) }}" min="0" required>
    </div>
  </div>
  <div class="mb-3" data-field="description">
    <label class="form-label">Description</label>
    <textarea class="form-control" name="description" rows="3">{{ form_data.get('description', wine.description or '') }}</textarea>
  </div>
  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-dark">Enregistrer</button>
    <a href="{{ url_for('wines.wine_detail', wine_id=wine.id) }}" class="btn btn-secondary">Annuler</a>
  </div>
</form>

<script>
(function() {
  const fieldSettings = {{ field_settings|tojson }};
  function updateFieldVisibility() {
    const select = document.getElementById('subcategory_id');
    const key = (select && select.value) ? select.value : 'default';
    const config = fieldSettings[key] || fieldSettings['default'];
    document.querySelectorAll('[data-field]').forEach((container) => {
      const fieldName = container.getAttribute('data-field');
      const settings = config[fieldName];
      const isEnabled = settings ? settings.enabled : true;
      const isRequired = settings ? settings.required : false;
      container.classList.toggle('d-none', !isEnabled);
      container.querySelectorAll('input, textarea, select').forEach((input) => {
        input.required = !!(isEnabled && isRequired);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('subcategory_id');
    if (select) {
      select.addEventListener('change', updateFieldVisibility);
    }
    updateFieldVisibility();
  });
})();
</script>
{% endblock %}
