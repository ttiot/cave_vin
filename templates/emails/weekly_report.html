<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport hebdomadaire - Cave √† Vin</title>
    <!--[if mso]>
    <noscript>
        <xml>
            <o:OfficeDocumentSettings>
                <o:PixelsPerInch>96</o:PixelsPerInch>
            </o:OfficeDocumentSettings>
        </xml>
    </noscript>
    <![endif]-->
    <style>
        /* Reset */
        body, table, td, p, a, li, blockquote {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        table, td {
            mso-table-lspace: 0pt;
            mso-table-rspace: 0pt;
        }
        img {
            -ms-interpolation-mode: bicubic;
            border: 0;
            height: auto;
            line-height: 100%;
            outline: none;
            text-decoration: none;
        }
        body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }
        
        /* Styles */
        .email-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #722f37, #9b4d56);
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        .content {
            background: #ffffff;
            padding: 30px;
            border: 1px solid #e0e0e0;
            border-top: none;
        }
        .section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #722f37;
        }
        .stat-grid {
            display: table;
            width: 100%;
        }
        .stat-item {
            display: table-cell;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #722f37;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-top: 5px;
        }
        .activity-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        .activity-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .activity-row:last-child {
            border-bottom: none;
            font-weight: bold;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .wine-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .wine-item {
            padding: 12px 15px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #722f37;
        }
        .wine-item.urgent {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .wine-item.optimal {
            border-left-color: #28a745;
            background: #f0fff4;
        }
        .wine-name {
            font-weight: bold;
            color: #333;
        }
        .wine-details {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-urgent {
            background: #dc3545;
            color: white;
        }
        .badge-optimal {
            background: #28a745;
            color: white;
        }
        .badge-soon {
            background: #ffc107;
            color: #333;
        }
        .cellar-table {
            width: 100%;
            border-collapse: collapse;
        }
        .cellar-table th,
        .cellar-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .cellar-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }
        .progress-fill {
            background: #722f37;
            height: 100%;
            border-radius: 10px;
        }
        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            border: 1px solid #e0e0e0;
            border-top: none;
        }
        .footer p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        @media screen and (max-width: 600px) {
            .email-container {
                width: 100% !important;
            }
            .content {
                padding: 20px !important;
            }
            .stat-item {
                display: block !important;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5;">
    <div class="email-container">
        <!-- Header -->
        <div class="header">
            <h1>üç∑ Cave √† Vin</h1>
            <p>Votre rapport hebdomadaire</p>
        </div>
        
        <!-- Content -->
        <div class="content">
            <!-- Greeting -->
            <p style="font-size: 16px; color: #333;">
                Bonjour <strong>{{ user.username }}</strong> !
            </p>
            <p style="color: #666; margin-bottom: 30px;">
                Voici le r√©sum√© de votre cave pour la semaine du 
                {{ report_period.start.strftime('%d/%m/%Y') }} au {{ report_period.end.strftime('%d/%m/%Y') }}.
            </p>
            
            <!-- Statistics Section -->
            <div class="section">
                <h2 class="section-title">üìä Vos caves en un coup d'≈ìil</h2>
                <table width="100%" cellpadding="0" cellspacing="10" style="margin-bottom: 20px;">
                    <tr>
                        <td width="50%" style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div class="stat-value">{{ statistics.total_bottles }}</div>
                            <div class="stat-label">Bouteilles</div>
                        </td>
                        <td width="50%" style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div class="stat-value">{{ statistics.total_references }}</div>
                            <div class="stat-label">R√©f√©rences</div>
                        </td>
                    </tr>
                </table>
                
                {% if statistics.cellars %}
                <table class="cellar-table">
                    <thead>
                        <tr>
                            <th>Cave</th>
                            <th>Bouteilles</th>
                            <th>Capacit√©</th>
                            <th>Remplissage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cellar in statistics.cellars %}
                        <tr>
                            <td>{{ cellar.name }}</td>
                            <td>{{ cellar.bottles }}</td>
                            <td>{{ cellar.capacity }}</td>
                            <td>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {{ cellar.fill_rate }}%;"></div>
                                </div>
                                <span style="font-size: 12px; color: #666;">{{ cellar.fill_rate }}%</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
            </div>
            
            <!-- Activity Section -->
            <div class="section">
                <h2 class="section-title">üìà Activit√© de la semaine</h2>
                <div class="activity-summary">
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #e0e0e0;">Entr√©es</td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #e0e0e0; text-align: right;" class="positive">
                                +{{ recent_activity.summary.total_entries }} bouteille{% if recent_activity.summary.total_entries > 1 %}s{% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; border-bottom: 1px solid #e0e0e0;">Sorties</td>
                            <td style="padding: 8px 0; border-bottom: 1px solid #e0e0e0; text-align: right;" class="negative">
                                -{{ recent_activity.summary.total_consumptions }} bouteille{% if recent_activity.summary.total_consumptions > 1 %}s{% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; font-weight: bold;">Variation nette</td>
                            <td style="padding: 8px 0; text-align: right; font-weight: bold;" class="{% if recent_activity.summary.net_change >= 0 %}positive{% else %}negative{% endif %}">
                                {% if recent_activity.summary.net_change >= 0 %}+{% endif %}{{ recent_activity.summary.net_change }} bouteille{% if recent_activity.summary.net_change|abs > 1 %}s{% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
                
                {% if recent_activity.entries %}
                <h3 style="font-size: 14px; color: #333; margin: 20px 0 10px;">Derni√®res entr√©es</h3>
                <ul class="wine-list">
                    {% for entry in recent_activity.entries[:5] %}
                    <li class="wine-item">
                        <div class="wine-name">{{ entry.name }}</div>
                        <div class="wine-details">
                            {% if entry.year %}{{ entry.year }} ‚Ä¢ {% endif %}
                            {% if entry.region %}{{ entry.region }} ‚Ä¢ {% endif %}
                            {{ entry.quantity }} bouteille{% if entry.quantity > 1 %}s{% endif %}
                            {% if entry.cellar_name %}‚Ä¢ {{ entry.cellar_name }}{% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
                
                {% if recent_activity.consumptions %}
                <h3 style="font-size: 14px; color: #333; margin: 20px 0 10px;">Derni√®res d√©gustations</h3>
                <ul class="wine-list">
                    {% for consumption in recent_activity.consumptions[:5] %}
                    <li class="wine-item">
                        <div class="wine-name">{{ consumption.name }}</div>
                        <div class="wine-details">
                            {% if consumption.year %}{{ consumption.year }} ‚Ä¢ {% endif %}
                            {% if consumption.region %}{{ consumption.region }} ‚Ä¢ {% endif %}
                            {{ consumption.consumed_at.strftime('%d/%m/%Y') }}
                            {% if consumption.comment %}<br><em>"{{ consumption.comment }}"</em>{% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            
            <!-- Wines to Consume Section -->
            {% if wines_to_consume %}
            <div class="section">
                <h2 class="section-title">üçæ √Ä consommer en priorit√©</h2>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                    Bas√© sur les informations de garde et l'√¢ge du mill√©sime
                </p>
                
                <ul class="wine-list">
                    {% for wine in wines_to_consume[:5] %}
                    <li class="wine-item {% if wine.urgency == 'urgent' %}urgent{% elif wine.urgency == 'optimal' %}optimal{% endif %}">
                        <table width="100%" cellpadding="0" cellspacing="0">
                            <tr>
                                <td>
                                    <div class="wine-name">
                                        {{ wine.name }}{% if wine.year %} ‚Äî {{ wine.year }}{% endif %}
                                    </div>
                                    <div class="wine-details">
                                        {% if wine.cellar_name %}{{ wine.cellar_name }}{% endif %}
                                        {% if wine.subcategory %}‚Ä¢ {{ wine.subcategory }}{% endif %}
                                    </div>
                                </td>
                                <td style="text-align: right; vertical-align: top;">
                                    <span class="badge {% if wine.urgency == 'urgent' %}badge-urgent{% elif wine.urgency == 'optimal' %}badge-optimal{% else %}badge-soon{% endif %}">
                                        Urgence {{ wine.urgency_score }}%
                                    </span>
                                </td>
                            </tr>
                        </table>
                        <!-- Barre de progression d'urgence -->
                        <div style="margin-top: 8px;">
                            <div class="progress-bar" style="height: 6px; background: #e0e0e0;">
                                <div style="width: {{ wine.urgency_score }}%; height: 100%; background: {% if wine.urgency_score >= 80 %}#dc3545{% elif wine.urgency_score >= 50 %}#ffc107{% else %}#28a745{% endif %}; border-radius: 10px;"></div>
                            </div>
                        </div>
                        {% if wine.garde_info %}
                        <div style="margin-top: 8px; font-size: 12px; color: #666; font-style: italic;">
                            {{ wine.garde_info[:200] }}{% if wine.garde_info|length > 200 %}...{% endif %}
                        </div>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                
                {% set urgent_count = wines_to_consume|selectattr('urgency', 'equalto', 'urgent')|list|length %}
                {% set optimal_count = wines_to_consume|selectattr('urgency', 'equalto', 'optimal')|list|length %}
                {% if urgent_count > 0 or optimal_count > 0 %}
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 13px;">
                    <strong>R√©sum√© :</strong>
                    {% if urgent_count > 0 %}
                    <span style="color: #dc3545;">{{ urgent_count }} vin{% if urgent_count > 1 %}s{% endif %} urgent{% if urgent_count > 1 %}s{% endif %}</span>
                    {% endif %}
                    {% if urgent_count > 0 and optimal_count > 0 %} ‚Ä¢ {% endif %}
                    {% if optimal_count > 0 %}
                    <span style="color: #28a745;">{{ optimal_count }} √† l'apog√©e</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="section">
                <h2 class="section-title">üçæ √Ä consommer en priorit√©</h2>
                <div class="empty-state">
                    <p>Aucun vin ne n√©cessite une attention particuli√®re pour le moment.</p>
                    <p style="font-size: 12px;">Les recommandations sont bas√©es sur l'√¢ge du vin, les informations de garde et l'ann√©e d'apog√©e.</p>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>
                Cet email a √©t√© envoy√© automatiquement par Cave √† Vin.<br>
                G√©n√©r√© le {{ generated_at.strftime('%d/%m/%Y √† %H:%M') }}
            </p>
        </div>
    </div>
</body>
</html>
