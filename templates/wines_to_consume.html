{% extends "base.html" %}
{% block extra_head %}
<style>
  .urgency-legend {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
  }
  
  .urgency-legend-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md) var(--spacing-lg);
    background-color: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: 0 2px 8px var(--shadow-color);
    transition: transform var(--transition-fast), box-shadow var(--transition-fast);
  }
  
  .urgency-legend-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-hover);
  }
  
  .urgency-legend-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
  }
  
  .urgency-legend-icon.urgent {
    background-color: var(--accent-danger);
    color: #fff;
  }
  
  .urgency-legend-icon.priority {
    background-color: var(--accent-warning);
    color: #1d1d1f;
  }
  
  .urgency-legend-icon.optimal {
    background-color: var(--accent-success);
    color: #fff;
  }
  
  .urgency-legend-icon.patience {
    background-color: var(--text-muted);
    color: #fff;
  }
  
  .urgency-legend-content {
    flex: 1;
    min-width: 0;
  }
  
  .urgency-legend-title {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
    margin-bottom: 2px;
  }
  
  .urgency-legend-desc {
    font-size: 0.8rem;
    color: var(--text-secondary);
    line-height: 1.3;
  }
  
  .urgency-legend-score {
    font-size: 0.7rem;
    color: var(--text-muted);
    font-family: 'SF Mono', Monaco, monospace;
  }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
  <h3>üç∑ Vins √† consommer prochainement</h3>
  <p class="text-muted">Cette page affiche les vins de votre cave en fonction de leur potentiel de garde et de leur √¢ge actuel.</p>
</div>

{% if wines_data %}
<!-- L√©gende moderne -->
<div class="urgency-legend">
  <div class="urgency-legend-item">
    <div class="urgency-legend-icon urgent">
      <i class="bi bi-exclamation-triangle-fill"></i>
    </div>
    <div class="urgency-legend-content">
      <div class="urgency-legend-title">Urgent</div>
      <div class="urgency-legend-desc">√Ä boire imm√©diatement</div>
      <div class="urgency-legend-score">Score ‚â• 80</div>
    </div>
  </div>
  
  <div class="urgency-legend-item">
    <div class="urgency-legend-icon priority">
      <i class="bi bi-clock-fill"></i>
    </div>
    <div class="urgency-legend-content">
      <div class="urgency-legend-title">Prioritaire</div>
      <div class="urgency-legend-desc">√Ä boire dans les prochains mois</div>
      <div class="urgency-legend-score">Score 50-79</div>
    </div>
  </div>
  
  <div class="urgency-legend-item">
    <div class="urgency-legend-icon optimal">
      <i class="bi bi-check-circle-fill"></i>
    </div>
    <div class="urgency-legend-content">
      <div class="urgency-legend-title">Optimal</div>
      <div class="urgency-legend-desc">Fen√™tre de garde id√©ale</div>
      <div class="urgency-legend-score">Score 30-49</div>
    </div>
  </div>
  
  <div class="urgency-legend-item">
    <div class="urgency-legend-icon patience">
      <i class="bi bi-hourglass-split"></i>
    </div>
    <div class="urgency-legend-content">
      <div class="urgency-legend-title">Patience</div>
      <div class="urgency-legend-desc">Peut encore attendre</div>
      <div class="urgency-legend-score">Score &lt; 30</div>
    </div>
  </div>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
  {% for item in wines_data %}
  {% set wine = item.wine %}
  {% set extras = wine.extra_attributes or {} %}
  {% set urgency = item.urgency_score %}
  {% set age = item.wine_age %}
  
  <div class="col">
    <div class="wine-card-modern animate-in"
         data-detail-url="{{ url_for('wines.wine_detail', wine_id=wine.id) }}">
      
      <!-- Image -->
      <div class="wine-card-image">
        {% if wine.label_image_data %}
        <img src="data:image/png;base64,{{ wine.label_image_data }}" alt="√âtiquette de {{ wine.name }}">
        {% elif wine.image_url %}
        <img src="{{ wine.image_url }}" alt="{{ wine.name }}">
        {% else %}
        <div class="wine-card-placeholder" aria-hidden="true">{{ wine.name[:1] }}</div>
        {% endif %}
        <span class="wine-card-quantity">√ó{{ wine.quantity }}</span>
        {% if urgency >= 80 %}
        <span class="wine-card-urgency urgent">Urgent</span>
        {% elif urgency >= 50 %}
        <span class="wine-card-urgency priority">Prioritaire</span>
        {% elif urgency >= 30 %}
        <span class="wine-card-urgency optimal">Optimal</span>
        {% else %}
        <span class="wine-card-urgency patience">Patience</span>
        {% endif %}
      </div>
      
      <!-- Corps -->
      <div class="wine-card-body">
        <h5 class="wine-card-title">{{ wine.name }}</h5>
        <p class="wine-card-subtitle">
          Mill√©sime {{ extras.year }} ‚Äî {{ age }} an{{ 's' if age > 1 else '' }}
        </p>
        
        {% if wine.subcategory %}
        <span class="wine-card-category" style="{{ wine.subcategory|subcategory_badge_style }}">
          {{ wine.subcategory.name }}
        </span>
        {% else %}
        <span class="wine-card-category" style="background-color: var(--text-muted); color: #fff;">
          Non cat√©goris√©
        </span>
        {% endif %}
        
        <div class="wine-card-info">
          {% if extras.region %}
          <div class="wine-card-info-item">
            <i class="bi bi-geo-alt"></i>
            <span>{{ extras.region }}</span>
          </div>
          {% endif %}
          {% if extras.get('grape') %}
          <div class="wine-card-info-item">
            <i class="bi bi-flower2"></i>
            <span>{{ extras.get('grape') }}</span>
          </div>
          {% endif %}
          {% if extras.get('volume_ml') %}
          <div class="wine-card-info-item">
            <i class="bi bi-droplet-half"></i>
            <span>{{ extras.get('volume_ml') }} mL</span>
          </div>
          {% endif %}
        </div>
        
        {% if item.recommended_years %}
        <div class="wine-card-garde">
          <i class="bi bi-hourglass-split me-1"></i>
          <strong>Potentiel de garde :</strong> {{ item.recommended_years[0] }} √† {{ item.recommended_years[1] }} ans
        </div>
        {% endif %}
        
        {% if item.garde_info %}
        <div class="wine-card-insights">
          <div class="wine-card-insights-content">
            {{ item.garde_info[:150] }}{% if item.garde_info|length > 150 %}...{% endif %}
          </div>
        </div>
        {% endif %}
        
        <!-- Barre de progression -->
        <div class="wine-card-progress">
          <div class="wine-card-progress-bar">
            <div class="wine-card-progress-fill
              {% if urgency >= 80 %}bg-danger
              {% elif urgency >= 50 %}bg-warning
              {% elif urgency >= 30 %}bg-success
              {% else %}bg-secondary{% endif %}"
              style="width: {{ urgency }}%;">
            </div>
          </div>
          <span class="wine-card-progress-label">Score d'urgence : {{ "%.0f"|format(urgency) }}/100</span>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="wine-card-footer">
        <div class="wine-card-footer-info">
          <span><i class="bi bi-box-seam me-1"></i>Cave : {{ wine.cellar.name }}</span>
        </div>
      </div>
      
      <!-- Actions -->
      <div class="wine-card-actions">
        <div class="wine-card-actions-grid with-comment">
          <form method="post" action="{{ url_for('wines.consume_wine', wine_id=wine.id) }}" class="wine-action-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="redirect" value="{{ url_for('search.wines_to_consume') }}">
            <input type="text" name="comment" class="wine-card-comment-input" placeholder="Commentaire (optionnel)">
            <div class="wine-card-action-buttons">
              <a href="{{ url_for('wines.wine_detail', wine_id=wine.id) }}" class="btn-wine-action btn-detail">
                <i class="bi bi-eye me-1"></i>D√©tails
              </a>
              <button type="submit" class="btn-wine-action btn-consume">
                <i class="bi bi-cup-straw me-1"></i>Consommer
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% else %}
<div class="alert alert-secondary">
  <h5>Aucun vin √† afficher</h5>
  <p class="mb-0">Aucun vin avec un mill√©sime n'a √©t√© trouv√© dans votre cave, ou aucune information de garde n'est disponible.</p>
  <p class="mb-0 mt-2">
    <a href="{{ url_for('main.index') }}" class="alert-link">Retour √† la liste des vins</a>
  </p>
</div>
{% endif %}

<div class="mt-4">
  <a href="{{ url_for('main.index') }}" class="btn btn-secondary">‚Üê Retour √† la cave</a>
</div>
{% endblock %}