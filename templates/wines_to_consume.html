{% extends "base.html" %}
{% block extra_head %}
<style>
  /* L√©gende d'urgence compacte */
  .urgency-legend {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-md);
    background-color: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: 0 2px 8px var(--shadow-color);
  }
  
  .urgency-legend-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-md);
    font-size: 0.8rem;
    transition: transform var(--transition-fast);
  }
  
  .urgency-legend-item:hover {
    transform: scale(1.02);
  }
  
  .urgency-legend-icon {
    width: 24px;
    height: 24px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    flex-shrink: 0;
  }
  
  .urgency-legend-icon.urgent { background-color: var(--accent-danger); color: #fff; }
  .urgency-legend-icon.priority { background-color: var(--accent-warning); color: #1d1d1f; }
  .urgency-legend-icon.optimal { background-color: var(--accent-success); color: #fff; }
  .urgency-legend-icon.patience { background-color: var(--text-muted); color: #fff; }
  
  .urgency-legend-text {
    color: var(--text-secondary);
    font-weight: 500;
  }
  
  .urgency-legend-score {
    font-size: 0.7rem;
    color: var(--text-muted);
    font-family: 'SF Mono', Monaco, monospace;
  }

  /* Grille de cartes compactes - 4 colonnes sur desktop */
  .wine-grid-compact {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--spacing-md);
  }
  
  @media (min-width: 1200px) {
    .wine-grid-compact {
      grid-template-columns: repeat(4, 1fr);
    }
  }
  
  @media (min-width: 1600px) {
    .wine-grid-compact {
      grid-template-columns: repeat(5, 1fr);
    }
  }

  /* Carte de vin compacte */
  .wine-card-compact {
    background-color: var(--bg-card);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: 0 2px 8px var(--shadow-color);
    transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative;
  }
  
  .wine-card-compact:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px var(--shadow-hover);
  }
  
  /* Header de la carte avec image */
  .wine-card-compact .card-header-img {
    position: relative;
    height: 120px;
    overflow: hidden;
    background: linear-gradient(135deg, rgba(114, 47, 55, 0.15), rgba(114, 47, 55, 0.05));
  }
  
  .wine-card-compact .card-header-img img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: var(--spacing-sm);
    transition: transform var(--transition-normal);
  }
  
  .wine-card-compact:hover .card-header-img img {
    transform: scale(1.05);
  }
  
  .wine-card-compact .card-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-light));
    color: rgba(255, 255, 255, 0.9);
    font-size: 2.5rem;
    font-weight: 700;
    text-transform: uppercase;
  }
  
  /* Badges sur l'image */
  .wine-card-compact .card-badges {
    position: absolute;
    top: var(--spacing-xs);
    left: var(--spacing-xs);
    right: var(--spacing-xs);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  
  .wine-card-compact .badge-urgency {
    padding: 0.2rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }
  
  .badge-urgency.urgent { background-color: var(--accent-danger); color: #fff; }
  .badge-urgency.priority { background-color: var(--accent-warning); color: #1d1d1f; }
  .badge-urgency.optimal { background-color: var(--accent-success); color: #fff; }
  .badge-urgency.patience { background-color: var(--text-muted); color: #fff; }
  
  .wine-card-compact .badge-quantity {
    background-color: var(--bg-card);
    color: var(--text-primary);
    padding: 0.2rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    font-weight: 600;
    box-shadow: 0 1px 4px var(--shadow-color);
  }
  
  /* Corps de la carte */
  .wine-card-compact .card-body-compact {
    padding: var(--spacing-sm) var(--spacing-md);
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
  }
  
  .wine-card-compact .wine-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin: 0;
  }
  
  .wine-card-compact .wine-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-secondary);
  }
  
  .wine-card-compact .wine-meta-item {
    display: flex;
    align-items: center;
    gap: 0.2rem;
  }
  
  .wine-card-compact .wine-meta-item i {
    font-size: 0.7rem;
    color: var(--text-muted);
  }
  
  /* Badge de cat√©gorie */
  .wine-card-compact .wine-category {
    display: inline-flex;
    align-items: center;
    padding: 0.15rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    font-weight: 500;
    width: fit-content;
  }
  
  /* Barre de progression compacte */
  .wine-card-compact .progress-compact {
    margin-top: auto;
    padding-top: var(--spacing-xs);
  }
  
  .wine-card-compact .progress-bar-compact {
    height: 4px;
    background-color: var(--bg-hover);
    border-radius: 2px;
    overflow: hidden;
  }
  
  .wine-card-compact .progress-fill {
    height: 100%;
    border-radius: 2px;
    transition: width var(--transition-normal);
  }
  
  .wine-card-compact .progress-label {
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-top: 2px;
  }
  
  /* Footer avec actions */
  .wine-card-compact .card-footer-compact {
    padding: var(--spacing-xs) var(--spacing-sm);
    background-color: var(--bg-hover);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: var(--spacing-xs);
  }
  
  .wine-card-compact .btn-action-compact {
    flex: 1;
    padding: 0.35rem 0.5rem;
    font-size: 0.7rem;
    font-weight: 500;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-color);
    background-color: var(--bg-card);
    color: var(--text-primary);
    transition: all var(--transition-fast);
    cursor: pointer;
    text-align: center;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
  }
  
  .wine-card-compact .btn-action-compact:hover {
    background-color: var(--bg-hover);
  }
  
  .wine-card-compact .btn-action-compact.btn-consume {
    border-color: var(--accent-success);
    color: var(--accent-success);
  }
  
  .wine-card-compact .btn-action-compact.btn-consume:hover {
    background-color: var(--accent-success);
    color: #fff;
  }
  
  .wine-card-compact .btn-action-compact.btn-detail {
    border-color: var(--accent-info);
    color: var(--accent-info);
  }
  
  .wine-card-compact .btn-action-compact.btn-detail:hover {
    background-color: var(--accent-info);
    color: #fff;
  }

  /* Modal d'enrichissement moderne */
  .wine-info-modal .modal-content {
    border: none;
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }
  
  .wine-info-modal .modal-header {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-dark));
    color: #fff;
    border: none;
    padding: var(--spacing-lg);
  }
  
  .wine-info-modal .modal-title {
    font-weight: 600;
    font-size: 1.1rem;
  }
  
  .wine-info-modal .btn-close {
    filter: brightness(0) invert(1);
    opacity: 0.8;
  }
  
  .wine-info-modal .btn-close:hover {
    opacity: 1;
  }
  
  .wine-info-modal .modal-body {
    padding: var(--spacing-lg);
    max-height: 60vh;
    overflow-y: auto;
  }
  
  .wine-info-modal .info-section {
    margin-bottom: var(--spacing-lg);
  }
  
  .wine-info-modal .info-section:last-child {
    margin-bottom: 0;
  }
  
  .wine-info-modal .info-section-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
    margin-bottom: var(--spacing-sm);
    padding-bottom: var(--spacing-xs);
    border-bottom: 2px solid var(--accent-primary);
  }
  
  .wine-info-modal .info-section-title i {
    color: var(--accent-primary);
  }
  
  .wine-info-modal .info-content {
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.6;
  }
  
  .wine-info-modal .info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-sm);
  }
  
  .wine-info-modal .info-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  
  .wine-info-modal .info-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    font-weight: 500;
  }
  
  .wine-info-modal .info-value {
    font-size: 0.85rem;
    color: var(--text-primary);
    font-weight: 500;
  }
  
  .wine-info-modal .garde-indicator {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background-color: var(--bg-hover);
    border-radius: var(--radius-md);
    margin-top: var(--spacing-sm);
  }
  
  .wine-info-modal .garde-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
  }
  
  .wine-info-modal .garde-icon.urgent { background-color: var(--accent-danger); color: #fff; }
  .wine-info-modal .garde-icon.priority { background-color: var(--accent-warning); color: #1d1d1f; }
  .wine-info-modal .garde-icon.optimal { background-color: var(--accent-success); color: #fff; }
  .wine-info-modal .garde-icon.patience { background-color: var(--text-muted); color: #fff; }
  
  .wine-info-modal .garde-text {
    flex: 1;
  }
  
  .wine-info-modal .garde-title {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
  }
  
  .wine-info-modal .garde-desc {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }
  
  .wine-info-modal .modal-footer {
    border-top: 1px solid var(--border-color);
    padding: var(--spacing-md) var(--spacing-lg);
    gap: var(--spacing-sm);
  }
  
  /* Animation d'entr√©e pour les cartes */
  @keyframes cardSlideIn {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .wine-card-compact {
    animation: cardSlideIn 0.3s ease forwards;
  }
  
  .wine-card-compact:nth-child(1) { animation-delay: 0.02s; }
  .wine-card-compact:nth-child(2) { animation-delay: 0.04s; }
  .wine-card-compact:nth-child(3) { animation-delay: 0.06s; }
  .wine-card-compact:nth-child(4) { animation-delay: 0.08s; }
  .wine-card-compact:nth-child(5) { animation-delay: 0.1s; }
  .wine-card-compact:nth-child(6) { animation-delay: 0.12s; }
  .wine-card-compact:nth-child(7) { animation-delay: 0.14s; }
  .wine-card-compact:nth-child(8) { animation-delay: 0.16s; }
  
  /* Responsive */
  @media (max-width: 576px) {
    .wine-grid-compact {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-sm);
    }
    
    .wine-card-compact .card-header-img {
      height: 100px;
    }
    
    .wine-card-compact .wine-name {
      font-size: 0.8rem;
    }
    
    .wine-card-compact .card-footer-compact {
      flex-direction: column;
    }
    
    .urgency-legend {
      flex-direction: column;
      gap: var(--spacing-xs);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="mb-3">
  <h3 class="mb-2">üç∑ Vins √† consommer prochainement</h3>
  <p class="text-muted small mb-0">Vins class√©s par urgence de consommation selon leur potentiel de garde.</p>
</div>

{% if wines_data %}
<!-- L√©gende compacte -->
<div class="urgency-legend">
  <div class="urgency-legend-item">
    <div class="urgency-legend-icon urgent"><i class="bi bi-exclamation-triangle-fill"></i></div>
    <span class="urgency-legend-text">Urgent</span>
    <span class="urgency-legend-score">‚â•80</span>
  </div>
  <div class="urgency-legend-item">
    <div class="urgency-legend-icon priority"><i class="bi bi-clock-fill"></i></div>
    <span class="urgency-legend-text">Prioritaire</span>
    <span class="urgency-legend-score">50-79</span>
  </div>
  <div class="urgency-legend-item">
    <div class="urgency-legend-icon optimal"><i class="bi bi-check-circle-fill"></i></div>
    <span class="urgency-legend-text">Optimal</span>
    <span class="urgency-legend-score">30-49</span>
  </div>
  <div class="urgency-legend-item">
    <div class="urgency-legend-icon patience"><i class="bi bi-hourglass-split"></i></div>
    <span class="urgency-legend-text">Patience</span>
    <span class="urgency-legend-score">&lt;30</span>
  </div>
</div>

<!-- Grille de cartes compactes -->
<div class="wine-grid-compact">
  {% for item in wines_data %}
  {% set wine = item.wine %}
  {% set extras = wine.extra_attributes or {} %}
  {% set urgency = item.urgency_score %}
  {% set age = item.wine_age %}
  
  <div class="wine-card-compact"
       data-wine-id="{{ wine.id }}"
       data-detail-url="{{ url_for('wines.wine_detail', wine_id=wine.id) }}"
       data-wine-name="{{ wine.name }}"
       data-wine-year="{{ extras.get('year', '') }}"
       data-wine-age="{{ age }}"
       data-wine-region="{{ extras.get('region', '') }}"
       data-wine-grape="{{ extras.get('grape', '') }}"
       data-wine-volume="{{ extras.get('volume_ml', '') }}"
       data-wine-cellar="{{ wine.cellar.name if wine.cellar else '' }}"
       data-wine-category="{{ wine.subcategory.name if wine.subcategory else 'Non cat√©goris√©' }}"
       data-wine-urgency="{{ urgency }}"
       data-wine-garde-info="{{ item.garde_info or '' }}"
       data-wine-recommended-min="{{ item.recommended_years[0] if item.recommended_years else '' }}"
       data-wine-recommended-max="{{ item.recommended_years[1] if item.recommended_years else '' }}"
       data-wine-insights="{{ (wine.insights | map(attribute='content') | list | join('|||')) if wine.insights else '' }}">
    
    <!-- Image avec badges -->
    <div class="card-header-img">
      {% if wine.label_image_data %}
      <img src="data:image/png;base64,{{ wine.label_image_data }}" alt="{{ wine.name }}">
      {% elif wine.image_url %}
      <img src="{{ wine.image_url }}" alt="{{ wine.name }}">
      {% else %}
      <div class="card-placeholder">{{ wine.name[:1] }}</div>
      {% endif %}
      
      <div class="card-badges">
        {% if urgency >= 80 %}
        <span class="badge-urgency urgent">Urgent</span>
        {% elif urgency >= 50 %}
        <span class="badge-urgency priority">Prioritaire</span>
        {% elif urgency >= 30 %}
        <span class="badge-urgency optimal">Optimal</span>
        {% else %}
        <span class="badge-urgency patience">Patience</span>
        {% endif %}
        <span class="badge-quantity">√ó{{ wine.quantity }}</span>
      </div>
    </div>
    
    <!-- Corps -->
    <div class="card-body-compact">
      <h6 class="wine-name">{{ wine.name }}</h6>
      
      <div class="wine-meta">
        <span class="wine-meta-item">
          <i class="bi bi-calendar3"></i>
          {{ extras.year }} ({{ age }}a)
        </span>
        {% if extras.region %}
        <span class="wine-meta-item">
          <i class="bi bi-geo-alt"></i>
          {{ extras.region[:15] }}{% if extras.region|length > 15 %}‚Ä¶{% endif %}
        </span>
        {% endif %}
      </div>
      
      {% if wine.subcategory %}
      <span class="wine-category" style="{{ wine.subcategory|subcategory_badge_style }}">
        {{ wine.subcategory.name }}
      </span>
      {% endif %}
      
      <!-- Barre de progression -->
      <div class="progress-compact">
        <div class="progress-bar-compact">
          <div class="progress-fill
            {% if urgency >= 80 %}bg-danger
            {% elif urgency >= 50 %}bg-warning
            {% elif urgency >= 30 %}bg-success
            {% else %}bg-secondary{% endif %}"
            style="width: {{ urgency }}%;">
          </div>
        </div>
        <div class="progress-label">Score : {{ "%.0f"|format(urgency) }}/100</div>
      </div>
    </div>
    
    <!-- Actions -->
    <div class="card-footer-compact">
      <button type="button" class="btn-action-compact btn-info-modal" title="Voir les informations">
        <i class="bi bi-info-circle"></i>
        <span class="d-none d-sm-inline">Infos</span>
      </button>
      <a href="{{ url_for('wines.wine_detail', wine_id=wine.id) }}" class="btn-action-compact btn-detail" onclick="event.stopPropagation();">
        <i class="bi bi-eye"></i>
        <span class="d-none d-sm-inline">D√©tails</span>
      </a>
      <form method="post" action="{{ url_for('wines.consume_wine', wine_id=wine.id) }}" class="flex-fill" onclick="event.stopPropagation();">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="redirect" value="{{ url_for('search.wines_to_consume') }}">
        <button type="submit" class="btn-action-compact btn-consume w-100">
          <i class="bi bi-cup-straw"></i>
          <span class="d-none d-sm-inline">Boire</span>
        </button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Modal d'informations enrichies -->
<div class="modal fade wine-info-modal" id="wineInfoModal" tabindex="-1" aria-labelledby="wineInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="wineInfoModalLabel">
          <i class="bi bi-info-circle me-2"></i>
          <span id="modalWineName">Informations du vin</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" id="modalWineContent">
        <!-- Contenu dynamique -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fermer</button>
        <a href="#" class="btn btn-primary btn-sm" id="modalDetailLink">
          <i class="bi bi-eye me-1"></i>Voir la fiche compl√®te
        </a>
      </div>
    </div>
  </div>
</div>

{% else %}
<div class="alert alert-secondary">
  <h5>Aucun vin √† afficher</h5>
  <p class="mb-0">Aucun vin avec un mill√©sime n'a √©t√© trouv√© dans votre cave, ou aucune information de garde n'est disponible.</p>
  <p class="mb-0 mt-2">
    <a href="{{ url_for('main.index') }}" class="alert-link">Retour √† la liste des vins</a>
  </p>
</div>
{% endif %}

<div class="mt-4">
  <a href="{{ url_for('main.index') }}" class="btn btn-secondary btn-sm">‚Üê Retour √† la cave</a>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('wineInfoModal');
  if (!modal) return;
  
  const bsModal = new bootstrap.Modal(modal);
  const modalTitle = document.getElementById('modalWineName');
  const modalContent = document.getElementById('modalWineContent');
  const modalDetailLink = document.getElementById('modalDetailLink');
  
  // Fonction pour √©chapper le HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
  
  // Gestionnaire pour les boutons d'info
  document.querySelectorAll('.btn-info-modal').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const card = this.closest('.wine-card-compact');
      const detailUrl = card.dataset.detailUrl;
      
      // R√©cup√©rer les donn√©es depuis les attributs data individuels
      const wineInfo = {
        name: card.dataset.wineName || '',
        year: card.dataset.wineYear || '',
        age: parseInt(card.dataset.wineAge) || 0,
        region: card.dataset.wineRegion || '',
        grape: card.dataset.wineGrape || '',
        volume: card.dataset.wineVolume || '',
        cellar: card.dataset.wineCellar || '',
        category: card.dataset.wineCategory || '',
        urgency: parseFloat(card.dataset.wineUrgency) || 0,
        gardeInfo: card.dataset.wineGardeInfo || '',
        recommendedMin: card.dataset.wineRecommendedMin || '',
        recommendedMax: card.dataset.wineRecommendedMax || '',
        insights: card.dataset.wineInsights ? card.dataset.wineInsights.split('|||').filter(i => i.trim()) : []
      };
      
      // Mettre √† jour le titre
      modalTitle.textContent = wineInfo.name;
      modalDetailLink.href = detailUrl;
      
      // Construire le contenu
      let content = '';
      
      // Section informations g√©n√©rales
      content += `
        <div class="info-section">
          <div class="info-section-title">
            <i class="bi bi-wine"></i>
            Informations g√©n√©rales
          </div>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Mill√©sime</span>
              <span class="info-value">${escapeHtml(wineInfo.year) || 'N/A'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">√Çge</span>
              <span class="info-value">${wineInfo.age} an${wineInfo.age > 1 ? 's' : ''}</span>
            </div>
            <div class="info-item">
              <span class="info-label">R√©gion</span>
              <span class="info-value">${escapeHtml(wineInfo.region) || 'N/A'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">C√©page</span>
              <span class="info-value">${escapeHtml(wineInfo.grape) || 'N/A'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Volume</span>
              <span class="info-value">${wineInfo.volume ? escapeHtml(wineInfo.volume) + ' mL' : 'N/A'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Cave</span>
              <span class="info-value">${escapeHtml(wineInfo.cellar) || 'N/A'}</span>
            </div>
          </div>
        </div>
      `;
      
      // Section potentiel de garde
      let urgencyClass = 'patience';
      let urgencyTitle = 'Patience';
      let urgencyDesc = 'Ce vin peut encore attendre';
      let urgencyIcon = 'bi-hourglass-split';
      
      if (wineInfo.urgency >= 80) {
        urgencyClass = 'urgent';
        urgencyTitle = '√Ä boire imm√©diatement';
        urgencyDesc = 'Ce vin a atteint ou d√©pass√© son apog√©e';
        urgencyIcon = 'bi-exclamation-triangle-fill';
      } else if (wineInfo.urgency >= 50) {
        urgencyClass = 'priority';
        urgencyTitle = '√Ä boire prochainement';
        urgencyDesc = 'Ce vin est dans sa fen√™tre de d√©gustation optimale';
        urgencyIcon = 'bi-clock-fill';
      } else if (wineInfo.urgency >= 30) {
        urgencyClass = 'optimal';
        urgencyTitle = 'Fen√™tre optimale';
        urgencyDesc = 'Ce vin entre dans sa p√©riode id√©ale';
        urgencyIcon = 'bi-check-circle-fill';
      }
      
      const hasRecommendedYears = wineInfo.recommendedMin && wineInfo.recommendedMax;
      
      content += `
        <div class="info-section">
          <div class="info-section-title">
            <i class="bi bi-hourglass-split"></i>
            Potentiel de garde
          </div>
          <div class="garde-indicator">
            <div class="garde-icon ${urgencyClass}">
              <i class="bi ${urgencyIcon}"></i>
            </div>
            <div class="garde-text">
              <div class="garde-title">${urgencyTitle}</div>
              <div class="garde-desc">${urgencyDesc}</div>
            </div>
          </div>
          ${hasRecommendedYears ? `
            <div class="info-content mt-2">
              <strong>Garde recommand√©e :</strong> ${escapeHtml(wineInfo.recommendedMin)} √† ${escapeHtml(wineInfo.recommendedMax)} ans
            </div>
          ` : ''}
        </div>
      `;
      
      // Section conseils de garde (si disponible)
      if (wineInfo.gardeInfo) {
        content += `
          <div class="info-section">
            <div class="info-section-title">
              <i class="bi bi-lightbulb"></i>
              Conseils
            </div>
            <div class="info-content">
              ${escapeHtml(wineInfo.gardeInfo)}
            </div>
          </div>
        `;
      }
      
      // Section insights (si disponibles)
      if (wineInfo.insights && wineInfo.insights.length > 0) {
        const insightsHtml = wineInfo.insights
          .slice(0, 3)
          .map(i => `<p class="mb-2">${escapeHtml(i)}</p>`)
          .join('');
        
        if (insightsHtml) {
          content += `
            <div class="info-section">
              <div class="info-section-title">
                <i class="bi bi-chat-quote"></i>
                Notes enrichies
              </div>
              <div class="info-content">
                ${insightsHtml}
              </div>
            </div>
          `;
        }
      }
      
      modalContent.innerHTML = content;
      bsModal.show();
    });
  });
  
  // Clic sur la carte pour aller aux d√©tails
  document.querySelectorAll('.wine-card-compact').forEach(card => {
    card.addEventListener('click', function(e) {
      // Ne pas naviguer si on clique sur un bouton ou un lien
      if (e.target.closest('button') || e.target.closest('a') || e.target.closest('form')) {
        return;
      }
      const url = this.dataset.detailUrl;
      if (url) {
        window.location.href = url;
      }
    });
  });
});
</script>
{% endblock %}
