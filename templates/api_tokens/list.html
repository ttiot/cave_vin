{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="bi bi-key me-2"></i>Mes tokens API</h1>
  <a href="{{ url_for('api_tokens.create_token') }}" class="btn btn-success">
    <i class="bi bi-plus-lg me-1"></i>Créer un token
  </a>
</div>

<div class="card">
  <div class="card-header">
    <i class="bi bi-list-ul me-1"></i>Liste des tokens
  </div>
  <div class="card-body">
    {% if tokens %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Préfixe</th>
            <th>Statut</th>
            <th>Créé le</th>
            <th>Dernière utilisation</th>
            <th>Expire le</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for token in tokens %}
          <tr>
            <td>
              <strong>{{ token.name }}</strong>
            </td>
            <td>
              <code>{{ token.token_prefix }}...</code>
            </td>
            <td>
              {% if not token.is_active %}
              <span class="badge bg-danger">Révoqué</span>
              {% elif token.is_expired %}
              <span class="badge bg-warning text-dark">Expiré</span>
              {% else %}
              <span class="badge bg-success">Actif</span>
              {% endif %}
            </td>
            <td>{{ token.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>
              {% if token.last_used_at %}
              {{ token.last_used_at.strftime('%d/%m/%Y %H:%M') }}
              {% else %}
              <span class="text-muted">Jamais</span>
              {% endif %}
            </td>
            <td>
              {% if token.expires_at %}
              {{ token.expires_at.strftime('%d/%m/%Y') }}
              {% else %}
              <span class="text-muted">Jamais</span>
              {% endif %}
            </td>
            <td class="text-end">
              {% if token.is_active %}
              <form method="POST" action="{{ url_for('api_tokens.revoke_token', token_id=token.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn btn-warning btn-sm" title="Révoquer" onclick="return confirm('Êtes-vous sûr de vouloir révoquer ce token ?')">
                  <i class="bi bi-slash-circle"></i>
                </button>
              </form>
              {% else %}
              <form method="POST" action="{{ url_for('api_tokens.activate_token', token_id=token.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn btn-success btn-sm" title="Réactiver">
                  <i class="bi bi-check-circle"></i>
                </button>
              </form>
              {% endif %}
              <form method="POST" action="{{ url_for('api_tokens.delete_token', token_id=token.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn btn-danger btn-sm" title="Supprimer" onclick="return confirm('Êtes-vous sûr de vouloir supprimer définitivement ce token ?')">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="bi bi-key display-1 text-muted"></i>
      <p class="mt-3 text-muted">Vous n'avez pas encore de token API.</p>
      <a href="{{ url_for('api_tokens.create_token') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i>Créer votre premier token
      </a>
    </div>
    {% endif %}
  </div>
</div>

<div class="card mt-4">
  <div class="card-header">
    <i class="bi bi-info-circle me-1"></i>Comment utiliser les tokens API
  </div>
  <div class="card-body">
    <p>Les tokens API vous permettent d'accéder à l'API de Cave à Vin depuis des applications tierces.</p>
    
    <h6>Authentification</h6>
    <p>Incluez votre token dans l'en-tête <code>Authorization</code> de vos requêtes :</p>
    <pre class="bg-light p-3 rounded"><code>Authorization: Bearer cv_votre_token_ici</code></pre>
    
    <p>Ou utilisez le paramètre <code>api_key</code> :</p>
    <pre class="bg-light p-3 rounded"><code>GET /api/endpoint?api_key=cv_votre_token_ici</code></pre>
    
    <h6 class="mt-4">Limites</h6>
    <p>Chaque token a une limite de requêtes par heure. En cas de dépassement, vous recevrez une erreur HTTP 429.</p>
  </div>
</div>
{% endblock %}
