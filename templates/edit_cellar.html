{% extends "base.html" %}
{% block content %}
<h3>Modifier la cave</h3>
<form method="POST" class="mt-3">
  <div class="mb-3">
    <label class="form-label">Nom de la cave</label>
    <input type="text" class="form-control" name="name" value="{{ cellar.name }}" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Catégorie de cave</label>
    <select class="form-select" name="category_id" required>
      <option value="" disabled>Sélectionnez une catégorie</option>
      {% for category in categories %}
      <option value="{{ category.id }}" {% if cellar.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
      {% endfor %}
    </select>
    <div class="form-text">
      Gérer les catégories : <a href="{{ url_for('cellar_categories.list_cellar_categories') }}" target="_blank">Catégories de caves</a>
    </div>
  </div>
  <div class="mb-3">
    <label class="form-label">Capacité par étage</label>
    <div id="floors-container" class="d-flex flex-column gap-2">
      {% for level in cellar.levels %}
      <div class="input-group floor-row">
        <span class="input-group-text">Étage {{ loop.index }}</span>
        <input type="number" class="form-control" name="floor_capacities" min="1" value="{{ level.capacity }}" required>
        <button type="button" class="btn btn-outline-danger remove-floor" {% if cellar.levels|length == 1 %}disabled{% endif %} aria-label="Supprimer l'étage {{ loop.index }}">&minus;</button>
      </div>
      {% endfor %}
    </div>
    <div class="d-flex justify-content-end mt-2">
      <button type="button" class="btn btn-outline-secondary btn-sm" id="add-floor">+ Ajouter un étage</button>
    </div>
  </div>
  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-dark flex-grow-1">Enregistrer les modifications</button>
    <a href="{{ url_for('cellars.list_cellars') }}" class="btn btn-outline-secondary">Annuler</a>
  </div>
</form>
<script>
  (function () {
    const container = document.getElementById('floors-container');
    const addFloorBtn = document.getElementById('add-floor');

    if (!container || !addFloorBtn) {
      return;
    }

    const updateFloorLabels = () => {
      const rows = container.querySelectorAll('.floor-row');
      rows.forEach((row, index) => {
        const label = row.querySelector('.input-group-text');
        const removeBtn = row.querySelector('.remove-floor');
        if (label) {
          label.textContent = `Étage ${index + 1}`;
        }
        if (removeBtn) {
          removeBtn.disabled = rows.length === 1;
          removeBtn.setAttribute('aria-label', `Supprimer l'étage ${index + 1}`);
        }
      });
    };

    const createRow = (value = '') => {
      const row = document.createElement('div');
      row.className = 'input-group floor-row';
      row.innerHTML = `
        <span class="input-group-text"></span>
        <input type="number" class="form-control" name="floor_capacities" min="1" value="${value}" required>
        <button type="button" class="btn btn-outline-danger remove-floor" aria-label="Supprimer l'étage">&minus;</button>
      `;
      return row;
    };

    container.addEventListener('click', (event) => {
      if (!(event.target instanceof HTMLElement)) {
        return;
      }
      if (event.target.classList.contains('remove-floor')) {
        event.preventDefault();
        const rows = container.querySelectorAll('.floor-row');
        if (rows.length > 1) {
          const row = event.target.closest('.floor-row');
          if (row) {
            row.remove();
            updateFloorLabels();
          }
        }
      }
    });

    addFloorBtn.addEventListener('click', (event) => {
      event.preventDefault();
      container.appendChild(createRow());
      updateFloorLabels();
    });

    updateFloorLabels();
  })();
</script>
{% endblock %}