{% extends "base.html" %}
{% block extra_head %}
<style>
  .cellar-tabs {
    gap: 0.75rem;
    overflow-x: auto;
    padding-bottom: 0.25rem;
    scrollbar-width: thin;
  }

  .cellar-tabs .nav-link {
    border-radius: 1.5rem;
    padding: 0.75rem 1.25rem;
    background: rgba(33, 37, 41, 0.06);
    color: #1f2933;
    transition: all 0.2s ease-in-out;
    min-width: 220px;
    text-align: left;
  }

  .cellar-tabs .nav-link small {
    font-size: 0.75rem;
  }

  .cellar-tabs .nav-link.active {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-light));
    color: #fff;
    box-shadow: 0 0.75rem 1.5rem rgba(114, 47, 55, 0.25);
  }

  .cellar-tabs .nav-link.active small {
    color: rgba(255, 255, 255, 0.8);
  }

  .cellar-metric {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 0.75rem 1rem;
    box-shadow: 0 2px 8px var(--shadow-color);
    height: 100%;
    transition: var(--transition-theme);
  }

  .cellar-metric .metric-label {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.65rem;
    color: var(--text-secondary);
    display: block;
    margin-bottom: 0.25rem;
  }

  .cellar-metric .metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    display: block;
  }

  .cellar-metric small {
    font-size: 0.7rem;
  }

  .cellar-tabs .nav-link {
    background: var(--bg-card);
    color: var(--text-primary);
  }

  [data-theme="dark"] .cellar-tabs .nav-link {
    background: var(--bg-hover);
  }

  .wine-highlight-chip {
    background: rgba(114, 47, 55, 0.1);
    color: var(--accent-primary);
    border-radius: 999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.7rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    border: 2px solid transparent;
  }

  .wine-highlight-chip:hover {
    background: rgba(114, 47, 55, 0.2);
    transform: translateY(-1px);
  }

  .wine-highlight-chip.active {
    background: var(--accent-primary);
    color: #fff;
    border-color: var(--accent-primary);
  }

  [data-theme="dark"] .wine-highlight-chip {
    background: rgba(139, 61, 71, 0.2);
    color: var(--accent-primary-light);
  }

  [data-theme="dark"] .wine-highlight-chip:hover {
    background: rgba(139, 61, 71, 0.35);
  }

  [data-theme="dark"] .wine-highlight-chip.active {
    background: var(--accent-primary-light);
    color: #1f2933;
  }

  .origin-chip {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    border: 2px solid transparent !important;
    font-size: 0.7rem;
  }

  .origin-chip:hover {
    background: rgba(33, 37, 41, 0.15) !important;
    transform: translateY(-1px);
  }

  .origin-chip.active {
    background: var(--accent-primary) !important;
    color: #fff !important;
    border-color: var(--accent-primary) !important;
  }

  [data-theme="dark"] .origin-chip.active {
    background: var(--accent-primary-light) !important;
    color: #1f2933 !important;
  }

  .filter-reset-btn {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
    border-radius: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    pointer-events: none;
  }

  .filter-reset-btn.visible {
    opacity: 1;
    pointer-events: auto;
  }

  .wine-card-hidden {
    display: none !important;
  }

  @media (max-width: 767.98px) {
    .cellar-tabs {
      flex-wrap: nowrap;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-2 mb-3">
  <div>
    <h3 class="m-0">Panorama des alcools</h3>
    <p class="text-muted small mb-0">Parcourez vos bouteilles par cave.</p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a href="{{ url_for('search.search_wines') }}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-search me-1"></i>Recherche
    </a>
    <a href="{{ url_for('wines.add_wine') }}" class="btn btn-dark btn-sm">
      <i class="bi bi-plus-lg me-1"></i>Ajouter
    </a>
  </div>
</div>

{% if not has_cellars %}
  <div class="alert alert-info">
    Vous n'avez pas encore créé de cave. <a href="{{ url_for('cellars.add_cellar') }}" class="alert-link">Ajoutez votre première cave</a>
    pour commencer à organiser vos alcools.
  </div>
{% else %}
  <ul class="nav nav-pills cellar-tabs mb-3" id="cellarTab" role="tablist">
    {% for panel in cellar_panels %}
      <li class="nav-item" role="presentation">
        <button class="nav-link{% if loop.first %} active{% endif %}" id="cellar-{{ panel.cellar.id }}-tab"
                data-bs-toggle="pill" data-bs-target="#cellar-{{ panel.cellar.id }}" type="button" role="tab"
                aria-controls="cellar-{{ panel.cellar.id }}" aria-selected="{{ 'true' if loop.first else 'false' }}">
          <span class="fw-semibold d-block">
            {{ panel.cellar.name }}
            {% if panel.is_default %}
            <i class="bi bi-star-fill text-warning ms-1" title="Cave par défaut"></i>
            {% endif %}
          </span>
          <small>{{ panel.total_quantity }} btl · {{ panel.wines|length }} réf.</small>
        </button>
      </li>
    {% endfor %}
  </ul>

  <div class="tab-content" id="cellarTabContent">
    {% for panel in cellar_panels %}
      <div class="tab-pane fade{% if loop.first %} show active{% endif %}" id="cellar-{{ panel.cellar.id }}" role="tabpanel"
           aria-labelledby="cellar-{{ panel.cellar.id }}-tab">
        
        <!-- Métriques compactes -->
        <div class="row g-2 mb-3">
          <div class="col-6 col-md-3">
            <div class="cellar-metric">
              <span class="metric-label">Bouteilles</span>
              <span class="metric-value">{{ panel.total_quantity }}</span>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="cellar-metric">
              <span class="metric-label">Références</span>
              <span class="metric-value">{{ panel.wines|length }}</span>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="cellar-metric">
              <span class="metric-label">Styles</span>
              <span class="metric-value">{{ panel.subcategory_labels|length }}</span>
            </div>
          </div>
          {% if panel.vintage_range %}
          <div class="col-6 col-md-3">
            <div class="cellar-metric">
              <span class="metric-label">Millésimes</span>
              <span class="metric-value">{{ panel.vintage_range[0] }}–{{ panel.vintage_range[1] }}</span>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Filtres compacts -->
        {% if panel.subcategory_labels %}
        <div class="mb-2 filter-section" data-cellar-id="{{ panel.cellar.id }}">
          <div class="d-flex align-items-center gap-2 mb-1">
            <span class="text-uppercase text-muted" style="font-size: 0.65rem;">Styles</span>
            <button type="button" class="btn btn-sm btn-outline-secondary filter-reset-btn" data-filter-type="style" data-cellar-id="{{ panel.cellar.id }}">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="d-flex flex-wrap gap-1 style-filters" data-cellar-id="{{ panel.cellar.id }}">
            {% for label in panel.subcategory_labels %}
            <span class="wine-highlight-chip" data-filter-style="{{ label }}" data-cellar-id="{{ panel.cellar.id }}">{{ label }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if panel.region_labels %}
        <div class="mb-3 filter-section" data-cellar-id="{{ panel.cellar.id }}">
          <div class="d-flex align-items-center gap-2 mb-1">
            <span class="text-uppercase text-muted" style="font-size: 0.65rem;">Origines</span>
            <button type="button" class="btn btn-sm btn-outline-secondary filter-reset-btn" data-filter-type="origin" data-cellar-id="{{ panel.cellar.id }}">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="d-flex flex-wrap gap-1 origin-filters" data-cellar-id="{{ panel.cellar.id }}">
            {% for label in panel.region_labels %}
            <span class="badge rounded-pill text-bg-light text-dark border origin-chip" data-filter-origin="{{ label }}" data-cellar-id="{{ panel.cellar.id }}">{{ label }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if panel.wines %}
        <!-- Grille de cartes compactes -->
        <div class="wine-grid-compact wine-cards-container" data-cellar-id="{{ panel.cellar.id }}">
          {% for wine in panel.wines %}
          {% set extras = wine.extra_attributes or {} %}
          <div class="wine-card-compact wine-card-col"
               data-wine-style="{{ wine.subcategory.name if wine.subcategory else '' }}"
               data-wine-origin="{{ extras.region or '' }}"
               data-cellar-id="{{ panel.cellar.id }}"
               data-detail-url="{{ url_for('wines.wine_detail', wine_id=wine.id) }}"
               data-wine-name="{{ wine.name }}"
               data-wine-year="{{ extras.get('year', '') }}"
               data-wine-region="{{ extras.get('region', '') }}"
               data-wine-grape="{{ extras.get('grape', '') }}"
               data-wine-volume="{{ extras.get('volume_ml', '') }}"
               data-wine-cellar="{{ panel.cellar.name }}"
               data-wine-category="{{ wine.subcategory.name if wine.subcategory else 'Non catégorisé' }}"
               data-wine-barcode="{{ wine.barcode or '' }}"
               data-wine-insights="{{ (wine.insights | map(attribute='content') | list | join('|||')) if wine.insights else '' }}">
            
            <!-- Image avec badges -->
            <div class="card-header-img">
              {% if wine.label_image_data %}
              <img src="data:image/png;base64,{{ wine.label_image_data }}" alt="{{ wine.name }}">
              {% elif wine.image_url %}
              <img src="{{ wine.image_url }}" alt="{{ wine.name }}">
              {% else %}
              <div class="card-placeholder">{{ wine.name[:1] }}</div>
              {% endif %}
              
              <div class="card-badges">
                {% if wine.quantity == 0 %}
                <span class="badge-urgency consumed">Épuisé</span>
                {% endif %}
                <span class="badge-quantity">×{{ wine.quantity }}</span>
              </div>
            </div>
            
            <!-- Corps -->
            <div class="card-body-compact">
              <h6 class="wine-name">{{ wine.name }}</h6>
              
              <div class="wine-meta">
                {% if extras.year %}
                <span class="wine-meta-item">
                  <i class="bi bi-calendar3"></i>
                  {{ extras.year }}
                </span>
                {% endif %}
                {% if extras.region %}
                <span class="wine-meta-item">
                  <i class="bi bi-geo-alt"></i>
                  {{ extras.region[:12] }}{% if extras.region|length > 12 %}…{% endif %}
                </span>
                {% endif %}
              </div>
              
              {% if wine.subcategory %}
              <span class="wine-category" style="{{ wine.subcategory|subcategory_badge_style }}">
                {{ wine.subcategory.name }}
              </span>
              {% endif %}
            </div>
            
            <!-- Actions -->
            <div class="card-footer-compact">
              <button type="button" class="btn-action-compact btn-info btn-info-modal" title="Informations">
                <i class="bi bi-info-circle"></i>
              </button>
              <a href="{{ url_for('wines.wine_detail', wine_id=wine.id) }}" class="btn-action-compact btn-detail" onclick="event.stopPropagation();">
                <i class="bi bi-eye"></i>
              </a>
              {% if wine.quantity > 0 %}
              <form method="post" action="{{ url_for('wines.consume_wine', wine_id=wine.id) }}" class="flex-fill" onclick="event.stopPropagation();">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="redirect" value="{{ request.path }}">
                <button type="submit" class="btn-action-compact btn-consume w-100">
                  <i class="bi bi-cup-straw"></i>
                </button>
              </form>
              {% endif %}
              <form method="post" action="{{ url_for('wines.delete_wine', wine_id=wine.id) }}" onclick="event.stopPropagation();" onsubmit="return confirm('Supprimer ce vin ?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="redirect" value="{{ request.path }}">
                <button type="submit" class="btn-action-compact btn-delete">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-light border shadow-sm">
          Cette cave est prête à accueillir de nouvelles bouteilles. <a href="{{ url_for('wines.add_wine') }}" class="alert-link">Ajoutez un premier alcool</a>
        </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}

<!-- Modal d'informations enrichies -->
<div class="modal fade wine-info-modal" id="wineInfoModal" tabindex="-1" aria-labelledby="wineInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="wineInfoModalLabel">
          <i class="bi bi-info-circle me-2"></i>
          <span id="modalWineName">Informations du vin</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" id="modalWineContent">
        <!-- Contenu dynamique -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fermer</button>
        <a href="#" class="btn btn-primary btn-sm" id="modalDetailLink">
          <i class="bi bi-eye me-1"></i>Fiche complète
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // État des filtres par cave
  const filterState = {};
  
  // Initialiser l'état pour chaque cave
  document.querySelectorAll('.wine-cards-container').forEach(container => {
    const cellarId = container.dataset.cellarId;
    filterState[cellarId] = {
      styles: new Set(),
      origins: new Set()
    };
  });
  
  // Fonction pour appliquer les filtres
  function applyFilters(cellarId) {
    const state = filterState[cellarId];
    const container = document.querySelector(`.wine-cards-container[data-cellar-id="${cellarId}"]`);
    if (!container) return;
    
    const cards = container.querySelectorAll('.wine-card-col');
    const originFilters = document.querySelector(`.origin-filters[data-cellar-id="${cellarId}"]`);
    
    const visibleOrigins = new Set();
    
    cards.forEach(card => {
      const cardStyle = card.dataset.wineStyle || '';
      const cardOrigin = card.dataset.wineOrigin || '';
      
      const matchesStyle = state.styles.size === 0 || state.styles.has(cardStyle);
      const matchesOrigin = state.origins.size === 0 || state.origins.has(cardOrigin);
      
      if (matchesStyle && matchesOrigin) {
        card.classList.remove('wine-card-hidden');
      } else {
        card.classList.add('wine-card-hidden');
      }
      
      if (matchesStyle && cardOrigin) {
        visibleOrigins.add(cardOrigin);
      }
    });
    
    if (originFilters && state.styles.size > 0) {
      originFilters.querySelectorAll('.origin-chip').forEach(chip => {
        const origin = chip.dataset.filterOrigin;
        if (visibleOrigins.has(origin)) {
          chip.style.display = '';
        } else {
          chip.style.display = 'none';
          if (state.origins.has(origin)) {
            state.origins.delete(origin);
            chip.classList.remove('active');
          }
        }
      });
    } else if (originFilters) {
      originFilters.querySelectorAll('.origin-chip').forEach(chip => {
        chip.style.display = '';
      });
    }
    
    const styleResetBtn = document.querySelector(`.filter-reset-btn[data-filter-type="style"][data-cellar-id="${cellarId}"]`);
    const originResetBtn = document.querySelector(`.filter-reset-btn[data-filter-type="origin"][data-cellar-id="${cellarId}"]`);
    
    if (styleResetBtn) {
      styleResetBtn.classList.toggle('visible', state.styles.size > 0);
    }
    if (originResetBtn) {
      originResetBtn.classList.toggle('visible', state.origins.size > 0);
    }
  }
  
  // Gestionnaire de clic sur les filtres de style
  document.querySelectorAll('.wine-highlight-chip[data-filter-style]').forEach(chip => {
    chip.addEventListener('click', function() {
      const cellarId = this.dataset.cellarId;
      const style = this.dataset.filterStyle;
      const state = filterState[cellarId];
      
      if (state.styles.has(style)) {
        state.styles.delete(style);
        this.classList.remove('active');
      } else {
        state.styles.add(style);
        this.classList.add('active');
      }
      
      applyFilters(cellarId);
    });
  });
  
  // Gestionnaire de clic sur les filtres d'origine
  document.querySelectorAll('.origin-chip[data-filter-origin]').forEach(chip => {
    chip.addEventListener('click', function() {
      const cellarId = this.dataset.cellarId;
      const origin = this.dataset.filterOrigin;
      const state = filterState[cellarId];
      
      if (state.origins.has(origin)) {
        state.origins.delete(origin);
        this.classList.remove('active');
      } else {
        state.origins.add(origin);
        this.classList.add('active');
      }
      
      applyFilters(cellarId);
    });
  });
  
  // Gestionnaire de clic sur les boutons de réinitialisation
  document.querySelectorAll('.filter-reset-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const cellarId = this.dataset.cellarId;
      const filterType = this.dataset.filterType;
      const state = filterState[cellarId];
      
      if (filterType === 'style') {
        state.styles.clear();
        document.querySelectorAll(`.wine-highlight-chip[data-cellar-id="${cellarId}"]`).forEach(c => {
          c.classList.remove('active');
        });
      } else if (filterType === 'origin') {
        state.origins.clear();
        document.querySelectorAll(`.origin-chip[data-cellar-id="${cellarId}"]`).forEach(c => {
          c.classList.remove('active');
        });
      }
      
      applyFilters(cellarId);
    });
  });
  
  // Modal d'informations
  const modal = document.getElementById('wineInfoModal');
  if (modal) {
    const bsModal = new bootstrap.Modal(modal);
    const modalTitle = document.getElementById('modalWineName');
    const modalContent = document.getElementById('modalWineContent');
    const modalDetailLink = document.getElementById('modalDetailLink');
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    document.querySelectorAll('.btn-info-modal').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const card = this.closest('.wine-card-compact');
        const detailUrl = card.dataset.detailUrl;
        
        const wineInfo = {
          name: card.dataset.wineName || '',
          year: card.dataset.wineYear || '',
          region: card.dataset.wineRegion || '',
          grape: card.dataset.wineGrape || '',
          volume: card.dataset.wineVolume || '',
          cellar: card.dataset.wineCellar || '',
          category: card.dataset.wineCategory || '',
          barcode: card.dataset.wineBarcode || '',
          insights: card.dataset.wineInsights ? card.dataset.wineInsights.split('|||').filter(i => i.trim()) : []
        };
        
        modalTitle.textContent = wineInfo.name;
        modalDetailLink.href = detailUrl;
        
        let content = `
          <div class="info-section">
            <div class="info-section-title">
              <i class="bi bi-wine"></i>
              Informations générales
            </div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Millésime</span>
                <span class="info-value">${escapeHtml(wineInfo.year) || 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Région</span>
                <span class="info-value">${escapeHtml(wineInfo.region) || 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Cépage</span>
                <span class="info-value">${escapeHtml(wineInfo.grape) || 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Volume</span>
                <span class="info-value">${wineInfo.volume ? escapeHtml(wineInfo.volume) + ' mL' : 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Cave</span>
                <span class="info-value">${escapeHtml(wineInfo.cellar) || 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Catégorie</span>
                <span class="info-value">${escapeHtml(wineInfo.category)}</span>
              </div>
            </div>
          </div>
        `;
        
        if (wineInfo.barcode) {
          content += `
            <div class="info-section">
              <div class="info-section-title">
                <i class="bi bi-upc"></i>
                Code-barres
              </div>
              <div class="info-content">
                <code>${escapeHtml(wineInfo.barcode)}</code>
              </div>
            </div>
          `;
        }
        
        if (wineInfo.insights && wineInfo.insights.length > 0) {
          const insightsHtml = wineInfo.insights
            .slice(0, 3)
            .map(i => `<p class="mb-2">${escapeHtml(i)}</p>`)
            .join('');
          
          content += `
            <div class="info-section">
              <div class="info-section-title">
                <i class="bi bi-chat-quote"></i>
                Notes enrichies
              </div>
              <div class="info-content">
                ${insightsHtml}
              </div>
            </div>
          `;
        }
        
        modalContent.innerHTML = content;
        bsModal.show();
      });
    });
    
    // Clic sur la carte pour aller aux détails
    document.querySelectorAll('.wine-card-compact').forEach(card => {
      card.addEventListener('click', function(e) {
        if (e.target.closest('button') || e.target.closest('a') || e.target.closest('form')) {
          return;
        }
        const url = this.dataset.detailUrl;
        if (url) {
          window.location.href = url;
        }
      });
    });
  }
});
</script>
{% endblock %}
