{% extends "base.html" %}
{% block extra_head %}
<style>
  .cellar-tabs {
    gap: 0.75rem;
    overflow-x: auto;
    padding-bottom: 0.25rem;
    scrollbar-width: thin;
  }

  .cellar-tabs .nav-link {
    border-radius: 1.5rem;
    padding: 0.75rem 1.25rem;
    background: rgba(33, 37, 41, 0.06);
    color: #1f2933;
    transition: all 0.2s ease-in-out;
    min-width: 220px;
    text-align: left;
  }

  .cellar-tabs .nav-link small {
    font-size: 0.75rem;
  }

  .cellar-tabs .nav-link.active {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-light));
    color: #fff;
    box-shadow: 0 0.75rem 1.5rem rgba(114, 47, 55, 0.25);
  }

  .cellar-tabs .nav-link.active small {
    color: rgba(255, 255, 255, 0.8);
  }

  .cellar-metric {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 1rem 1.25rem;
    box-shadow: 0 4px 6px -1px var(--shadow-color), 0 10px 20px -5px var(--shadow-color);
    height: 100%;
    transition: var(--transition-theme);
  }

  .cellar-metric .metric-label {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.75rem;
    color: var(--text-secondary);
    display: block;
    margin-bottom: 0.5rem;
  }

  .cellar-metric .metric-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    display: block;
  }

  .cellar-tabs .nav-link {
    background: var(--bg-card);
    color: var(--text-primary);
  }

  [data-theme="dark"] .cellar-tabs .nav-link {
    background: var(--bg-hover);
  }

  .wine-highlight-chip {
    background: rgba(114, 47, 55, 0.1);
    color: var(--accent-primary);
    border-radius: 999px;
    padding: 0.35rem 0.9rem;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    border: 2px solid transparent;
  }

  .wine-highlight-chip:hover {
    background: rgba(114, 47, 55, 0.2);
    transform: translateY(-1px);
  }

  .wine-highlight-chip.active {
    background: var(--accent-primary);
    color: #fff;
    border-color: var(--accent-primary);
  }

  [data-theme="dark"] .wine-highlight-chip {
    background: rgba(139, 61, 71, 0.2);
    color: var(--accent-primary-light);
  }

  [data-theme="dark"] .wine-highlight-chip:hover {
    background: rgba(139, 61, 71, 0.35);
  }

  [data-theme="dark"] .wine-highlight-chip.active {
    background: var(--accent-primary-light);
    color: #1f2933;
  }

  .origin-chip {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    border: 2px solid transparent !important;
  }

  .origin-chip:hover {
    background: rgba(33, 37, 41, 0.15) !important;
    transform: translateY(-1px);
  }

  .origin-chip.active {
    background: var(--accent-primary) !important;
    color: #fff !important;
    border-color: var(--accent-primary) !important;
  }

  [data-theme="dark"] .origin-chip.active {
    background: var(--accent-primary-light) !important;
    color: #1f2933 !important;
  }

  .filter-reset-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    pointer-events: none;
  }

  .filter-reset-btn.visible {
    opacity: 1;
    pointer-events: auto;
  }

  .wine-card-hidden {
    display: none !important;
  }

  @media (max-width: 767.98px) {
    .cellar-tabs {
      flex-wrap: nowrap;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-4">
  <div>
    <h3 class="m-0">Panorama des alcools</h3>
    <p class="text-muted mb-0">Parcourez vos bouteilles par cave, avec une mise en page moderne et immersive.</p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a href="{{ url_for('search.search_wines') }}" class="btn btn-outline-secondary">
      <i class="bi bi-search me-1"></i> Recherche avancée
    </a>
    <a href="{{ url_for('wines.add_wine') }}" class="btn btn-dark">
      <i class="bi bi-plus-lg me-1"></i> Ajouter une bouteille
    </a>
  </div>
</div>

{% if not has_cellars %}
  <div class="alert alert-info">
    Vous n'avez pas encore créé de cave. <a href="{{ url_for('cellars.add_cellar') }}" class="alert-link">Ajoutez votre première cave</a>
    pour commencer à organiser vos alcools.
  </div>
{% else %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-3">
      <div>
        <h5 class="mb-1">Votre collection</h5>
        <p class="text-muted mb-0">{{ total_wine_count }} référence{% if total_wine_count > 1 %}s{% endif %} suivie{% if total_wine_count > 1 %}s{% endif %} dans l'application.</p>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <span class="badge text-bg-dark">Vue interactive par cave</span>
        <span class="badge text-bg-light text-dark">Mises à jour en temps réel</span>
      </div>
    </div>
  </div>

  <ul class="nav nav-pills cellar-tabs mb-4" id="cellarTab" role="tablist">
    {% for panel in cellar_panels %}
      <li class="nav-item" role="presentation">
        <button class="nav-link{% if loop.first %} active{% endif %}" id="cellar-{{ panel.cellar.id }}-tab"
                data-bs-toggle="pill" data-bs-target="#cellar-{{ panel.cellar.id }}" type="button" role="tab"
                aria-controls="cellar-{{ panel.cellar.id }}" aria-selected="{{ 'true' if loop.first else 'false' }}">
          <span class="fw-semibold d-block">
            {{ panel.cellar.name }}
            {% if panel.is_default %}
            <i class="bi bi-star-fill text-warning ms-1" title="Cave par défaut"></i>
            {% endif %}
          </span>
          <small>{{ panel.total_quantity }} bouteille{% if panel.total_quantity > 1 %}s{% endif %} · {{ panel.wines|length }} référence{% if panel.wines|length > 1 %}s{% endif %}</small>
        </button>
      </li>
    {% endfor %}
  </ul>

  <div class="tab-content" id="cellarTabContent">
    {% for panel in cellar_panels %}
      <div class="tab-pane fade{% if loop.first %} show active{% endif %}" id="cellar-{{ panel.cellar.id }}" role="tabpanel"
           aria-labelledby="cellar-{{ panel.cellar.id }}-tab">
        <div class="row g-3 mb-4">
          <div class="col-sm-6 col-xl-3">
            <div class="cellar-metric">
              <span class="metric-label">Bouteilles en stock</span>
              <span class="metric-value">{{ panel.total_quantity }}</span>
              <small class="text-muted">Quantité totale disponible</small>
            </div>
          </div>
          <div class="col-sm-6 col-xl-3">
            <div class="cellar-metric">
              <span class="metric-label">Références suivies</span>
              <span class="metric-value">{{ panel.wines|length }}</span>
              <small class="text-muted">Fiches individuelles</small>
            </div>
          </div>
          <div class="col-sm-6 col-xl-3">
            <div class="cellar-metric">
              <span class="metric-label">Styles représentés</span>
              <span class="metric-value">{{ panel.subcategory_labels|length }}</span>
              <small class="text-muted">Catégories et sous-catégories</small>
            </div>
          </div>
          {% if panel.vintage_range %}
          <div class="col-sm-6 col-xl-3">
            <div class="cellar-metric">
              <span class="metric-label">Millésimes</span>
              <span class="metric-value">{{ panel.vintage_range[0] }} – {{ panel.vintage_range[1] }}</span>
              <small class="text-muted">Amplitude des années</small>
            </div>
          </div>
          {% endif %}
        </div>

        {% if panel.subcategory_labels %}
        <div class="mb-3 filter-section" data-cellar-id="{{ panel.cellar.id }}">
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="text-uppercase text-muted small">Styles en cave</span>
            <button type="button" class="btn btn-sm btn-outline-secondary filter-reset-btn" data-filter-type="style" data-cellar-id="{{ panel.cellar.id }}">
              <i class="bi bi-x-lg me-1"></i>Réinitialiser
            </button>
          </div>
          <div class="d-flex flex-wrap gap-2 style-filters" data-cellar-id="{{ panel.cellar.id }}">
            {% for label in panel.subcategory_labels %}
            <span class="wine-highlight-chip" data-filter-style="{{ label }}" data-cellar-id="{{ panel.cellar.id }}">{{ label }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if panel.region_labels %}
        <div class="mb-4 filter-section" data-cellar-id="{{ panel.cellar.id }}">
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="text-uppercase text-muted small">Origines</span>
            <button type="button" class="btn btn-sm btn-outline-secondary filter-reset-btn" data-filter-type="origin" data-cellar-id="{{ panel.cellar.id }}">
              <i class="bi bi-x-lg me-1"></i>Réinitialiser
            </button>
          </div>
          <div class="d-flex flex-wrap gap-2 origin-filters" data-cellar-id="{{ panel.cellar.id }}">
            {% for label in panel.region_labels %}
            <span class="badge rounded-pill text-bg-light text-dark border origin-chip" data-filter-origin="{{ label }}" data-cellar-id="{{ panel.cellar.id }}">{{ label }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if panel.wines %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 wine-cards-container" data-cellar-id="{{ panel.cellar.id }}">
          {% for wine in panel.wines %}
          {% set extras = wine.extra_attributes or {} %}
          <div class="col wine-card-col"
               data-wine-style="{{ wine.subcategory.name if wine.subcategory else '' }}"
               data-wine-origin="{{ extras.region or '' }}"
               data-cellar-id="{{ panel.cellar.id }}">
            <div class="wine-card-modern animate-in"
                 data-detail-url="{{ url_for('wines.wine_detail', wine_id=wine.id) }}"
                 data-wine-preview='{{ wine.preview_insights()|tojson }}'>
              
              <!-- Image -->
              <div class="wine-card-image">
                {% if wine.label_image_data %}
                <img src="data:image/png;base64,{{ wine.label_image_data }}" alt="Étiquette de {{ wine.name }}">
                {% elif wine.image_url %}
                <img src="{{ wine.image_url }}" alt="{{ wine.name }}">
                {% else %}
                <div class="wine-card-placeholder" aria-hidden="true">{{ wine.name[:1] }}</div>
                {% endif %}
                <span class="wine-card-quantity">×{{ wine.quantity }}</span>
              </div>
              
              <!-- Corps -->
              <div class="wine-card-body">
                <h5 class="wine-card-title">{{ wine.name }}</h5>
                <p class="wine-card-subtitle">
                  {% if extras.year %}
                    Millésime {{ extras.year }}
                  {% elif extras.get('aging_potential') %}
                    {{ extras.get('aging_potential') }}
                  {% else %}
                    Millésime non renseigné
                  {% endif %}
                </p>
                
                {% if wine.subcategory %}
                <span class="wine-card-category" style="{{ wine.subcategory|subcategory_badge_style }}">
                  {{ wine.subcategory.name }}
                </span>
                {% else %}
                <span class="wine-card-category" style="background-color: var(--text-muted); color: #fff;">
                  Non catégorisé
                </span>
                {% endif %}
                
                <div class="wine-card-info">
                  <div class="wine-card-info-item">
                    <i class="bi bi-geo-alt"></i>
                    <span>{{ extras.region or 'Région inconnue' }}</span>
                  </div>
                  {% if extras.get('grape') %}
                  <div class="wine-card-info-item">
                    <i class="bi bi-flower2"></i>
                    <span>{{ extras.get('grape') }}</span>
                  </div>
                  {% endif %}
                  {% if extras.get('volume_ml') %}
                  <div class="wine-card-info-item">
                    <i class="bi bi-droplet-half"></i>
                    <span>{{ extras.get('volume_ml') }} mL</span>
                  </div>
                  {% endif %}
                </div>
                
                {% if wine.barcode %}
                <span class="wine-card-ean">
                  <i class="bi bi-upc"></i> {{ wine.barcode }}
                </span>
                {% endif %}
              </div>
              
              <!-- Actions -->
              <div class="wine-card-actions">
                <div class="wine-card-actions-grid with-comment">
                  <form method="post" action="{{ url_for('wines.consume_wine', wine_id=wine.id) }}" class="wine-action-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="redirect" value="{{ request.path }}">
                    <input type="text" name="comment" class="wine-card-comment-input" placeholder="Commentaire (optionnel)">
                    <div class="wine-card-action-buttons">
                      <button type="submit" class="btn-wine-action btn-consume">
                        <i class="bi bi-cup-straw me-1"></i>Consommer
                      </button>
                  </form>
                  <form method="post" action="{{ url_for('wines.refresh_wine', wine_id=wine.id) }}" class="wine-action-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="redirect" value="{{ request.path }}">
                    <button type="submit" class="btn-wine-action btn-refresh">
                      <i class="bi bi-arrow-clockwise me-1"></i>Rafraîchir
                    </button>
                  </form>
                  <form method="post" action="{{ url_for('wines.delete_wine', wine_id=wine.id) }}" class="wine-action-form" data-confirm="Supprimer définitivement ce vin ?">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="redirect" value="{{ request.path }}">
                    <button type="submit" class="btn-wine-action btn-delete">
                      <i class="bi bi-trash me-1"></i>Supprimer
                    </button>
                  </form>
                    </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-light border shadow-sm">
          Cette cave est prête à accueillir de nouvelles bouteilles. <a href="{{ url_for('wines.add_wine') }}" class="alert-link">Ajoutez un premier alcool</a>
          pour remplir cette section.
        </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // État des filtres par cave - utilise des Sets pour permettre la sélection multiple
  const filterState = {};
  
  // Initialiser l'état pour chaque cave
  document.querySelectorAll('.wine-cards-container').forEach(container => {
    const cellarId = container.dataset.cellarId;
    filterState[cellarId] = {
      styles: new Set(),  // Plusieurs styles possibles
      origins: new Set()  // Plusieurs origines possibles
    };
  });
  
  // Fonction pour appliquer les filtres
  function applyFilters(cellarId) {
    const state = filterState[cellarId];
    const container = document.querySelector(`.wine-cards-container[data-cellar-id="${cellarId}"]`);
    if (!container) return;
    
    const cards = container.querySelectorAll('.wine-card-col');
    const originFilters = document.querySelector(`.origin-filters[data-cellar-id="${cellarId}"]`);
    
    // Collecter les origines visibles basées sur les filtres de style actifs
    const visibleOrigins = new Set();
    
    cards.forEach(card => {
      const cardStyle = card.dataset.wineStyle || '';
      const cardOrigin = card.dataset.wineOrigin || '';
      
      // Vérifier si la carte correspond aux filtres
      // Si aucun style sélectionné, tous les styles passent
      // Si des styles sont sélectionnés, le style de la carte doit être dans la liste
      const matchesStyle = state.styles.size === 0 || state.styles.has(cardStyle);
      const matchesOrigin = state.origins.size === 0 || state.origins.has(cardOrigin);
      
      if (matchesStyle && matchesOrigin) {
        card.classList.remove('wine-card-hidden');
      } else {
        card.classList.add('wine-card-hidden');
      }
      
      // Collecter les origines des cartes qui correspondent aux filtres de style
      if (matchesStyle && cardOrigin) {
        visibleOrigins.add(cardOrigin);
      }
    });
    
    // Mettre à jour la visibilité des chips d'origine basée sur les filtres de style
    if (originFilters && state.styles.size > 0) {
      originFilters.querySelectorAll('.origin-chip').forEach(chip => {
        const origin = chip.dataset.filterOrigin;
        if (visibleOrigins.has(origin)) {
          chip.style.display = '';
        } else {
          // Masquer le chip mais aussi le désélectionner s'il était actif
          chip.style.display = 'none';
          if (state.origins.has(origin)) {
            state.origins.delete(origin);
            chip.classList.remove('active');
          }
        }
      });
    } else if (originFilters) {
      // Réafficher tous les chips d'origine si pas de filtre de style
      originFilters.querySelectorAll('.origin-chip').forEach(chip => {
        chip.style.display = '';
      });
    }
    
    // Mettre à jour les boutons de réinitialisation
    const styleResetBtn = document.querySelector(`.filter-reset-btn[data-filter-type="style"][data-cellar-id="${cellarId}"]`);
    const originResetBtn = document.querySelector(`.filter-reset-btn[data-filter-type="origin"][data-cellar-id="${cellarId}"]`);
    
    if (styleResetBtn) {
      styleResetBtn.classList.toggle('visible', state.styles.size > 0);
    }
    if (originResetBtn) {
      originResetBtn.classList.toggle('visible', state.origins.size > 0);
    }
    
    // Mettre à jour le compteur de filtres actifs (optionnel, pour feedback visuel)
    updateFilterCount(cellarId, state);
  }
  
  // Fonction pour mettre à jour le compteur de filtres (feedback visuel)
  function updateFilterCount(cellarId, state) {
    const styleResetBtn = document.querySelector(`.filter-reset-btn[data-filter-type="style"][data-cellar-id="${cellarId}"]`);
    const originResetBtn = document.querySelector(`.filter-reset-btn[data-filter-type="origin"][data-cellar-id="${cellarId}"]`);
    
    if (styleResetBtn && state.styles.size > 0) {
      styleResetBtn.innerHTML = `<i class="bi bi-x-lg me-1"></i>Réinitialiser (${state.styles.size})`;
    } else if (styleResetBtn) {
      styleResetBtn.innerHTML = `<i class="bi bi-x-lg me-1"></i>Réinitialiser`;
    }
    
    if (originResetBtn && state.origins.size > 0) {
      originResetBtn.innerHTML = `<i class="bi bi-x-lg me-1"></i>Réinitialiser (${state.origins.size})`;
    } else if (originResetBtn) {
      originResetBtn.innerHTML = `<i class="bi bi-x-lg me-1"></i>Réinitialiser`;
    }
  }
  
  // Gestionnaire de clic sur les filtres de style (sélection multiple)
  document.querySelectorAll('.wine-highlight-chip[data-filter-style]').forEach(chip => {
    chip.addEventListener('click', function() {
      const cellarId = this.dataset.cellarId;
      const style = this.dataset.filterStyle;
      const state = filterState[cellarId];
      
      // Toggle le filtre dans le Set
      if (state.styles.has(style)) {
        state.styles.delete(style);
        this.classList.remove('active');
      } else {
        state.styles.add(style);
        this.classList.add('active');
      }
      
      applyFilters(cellarId);
    });
  });
  
  // Gestionnaire de clic sur les filtres d'origine (sélection multiple)
  document.querySelectorAll('.origin-chip[data-filter-origin]').forEach(chip => {
    chip.addEventListener('click', function() {
      const cellarId = this.dataset.cellarId;
      const origin = this.dataset.filterOrigin;
      const state = filterState[cellarId];
      
      // Toggle le filtre dans le Set
      if (state.origins.has(origin)) {
        state.origins.delete(origin);
        this.classList.remove('active');
      } else {
        state.origins.add(origin);
        this.classList.add('active');
      }
      
      applyFilters(cellarId);
    });
  });
  
  // Gestionnaire de clic sur les boutons de réinitialisation
  document.querySelectorAll('.filter-reset-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const cellarId = this.dataset.cellarId;
      const filterType = this.dataset.filterType;
      const state = filterState[cellarId];
      
      if (filterType === 'style') {
        state.styles.clear();
        document.querySelectorAll(`.wine-highlight-chip[data-cellar-id="${cellarId}"]`).forEach(c => {
          c.classList.remove('active');
        });
      } else if (filterType === 'origin') {
        state.origins.clear();
        document.querySelectorAll(`.origin-chip[data-cellar-id="${cellarId}"]`).forEach(c => {
          c.classList.remove('active');
        });
      }
      
      applyFilters(cellarId);
    });
  });
  
  // Gestionnaire de clic sur les cartes de vin pour naviguer vers le détail
  document.querySelectorAll('.wine-card-modern[data-detail-url]').forEach(card => {
    card.addEventListener('click', function(e) {
      // Ne pas naviguer si on clique sur un élément interactif (bouton, input, formulaire)
      const target = e.target;
      const isInteractive = target.closest('button, input, form, a, .wine-card-actions');
      
      if (!isInteractive) {
        const detailUrl = this.dataset.detailUrl;
        if (detailUrl) {
          window.location.href = detailUrl;
        }
      }
    });
  });
});
</script>
{% endblock %}
