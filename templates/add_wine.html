{% extends "base.html" %}
{% block content %}
{% set form_data = form_data or request.form %}
{% set raw_cellar = form_data.get('cellar_id') %}
{% if raw_cellar %}
  {% set current_cellar_id = raw_cellar|int %}
{% else %}
  {% set current_cellar_id = selected_cellar_id %}
{% endif %}
{% set raw_subcategory = form_data.get('subcategory_id') %}
{% if raw_subcategory %}
  {% set current_subcategory_id = raw_subcategory|int %}
{% else %}
  {% set current_subcategory_id = selected_subcategory_id %}
{% endif %}

<h3>Ajouter une bouteille</h3>
<form method="POST" enctype="multipart/form-data">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
  <div class="mb-3">
    <label class="form-label">Cave</label>
    <select class="form-select" name="cellar_id" required>
      <option value="" disabled {% if not current_cellar_id %}selected{% endif %}>Sélectionnez une cave</option>
      {% for cellar in cellars %}
      <option value="{{ cellar.id }}" {% if current_cellar_id==cellar.id %}selected{% endif %}>
        {{ cellar.name }}{% if cellar.category %} — {{ cellar.category.name }}{% endif %}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Type d'alcool</label>
    <select class="form-select" name="subcategory_id" id="subcategory_id">
      <option value="" {% if not current_subcategory_id %}selected{% endif %}>Non spécifié</option>
      {% for category in categories %}
        <optgroup label="{{ category.name }}">
          {% for subcategory in category.subcategories %}
            <option value="{{ subcategory.id }}" {% if current_subcategory_id==subcategory.id %}selected{% endif %}>{{ subcategory.name }}</option>
          {% endfor %}
        </optgroup>
      {% endfor %}
    </select>
    <div class="form-text">Sélectionnez le type d'alcool (vin rouge, rhum ambré, etc.)</div>
  </div>
  <div class="mb-3">
    <label class="form-label">Nom</label>
    <input type="text" class="form-control" name="name" placeholder="Ex: Château Margaux" value="{{ form_data.get('name', '') }}">
  </div>
  <div class="row" data-dynamic-fields>
    {% for field in ordered_fields %}
    <div class="col-md-{{ field.form_width or 12 }} mb-3" data-field="{{ field.name }}">
      <label class="form-label">{{ field.label }}</label>
      {% if field.input_type == 'textarea' %}
        <textarea class="form-control" name="{{ field.name }}" rows="3" placeholder="{{ field.placeholder or '' }}">{{ form_data.get(field.name, '') }}</textarea>
      {% elif field.input_type == 'number' %}
        <input type="number" class="form-control" name="{{ field.name }}" value="{{ form_data.get(field.name, '') }}" placeholder="{{ field.placeholder or '' }}" {% if field.name == 'year' %}min="1000" max="3000"{% elif field.name == 'volume_ml' %}min="10" step="10"{% endif %}>
      {% elif field.input_type == 'decimal' %}
        <input type="number" class="form-control" step="any" inputmode="decimal" name="{{ field.name }}" value="{{ form_data.get(field.name, '') }}" placeholder="{{ field.placeholder or '' }}">
      {% else %}
        <input type="text" class="form-control" name="{{ field.name }}" value="{{ form_data.get(field.name, '') }}" placeholder="{{ field.placeholder or '' }}">
      {% endif %}
      {% if field.help_text %}
      <div class="form-text">{{ field.help_text }}</div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  
  <!-- Section image -->
  <div class="card mb-3">
    <div class="card-header">
      <i class="bi bi-image me-2"></i>Photo de l'étiquette
    </div>
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-8">
          <input type="file" class="form-control" name="label_image" id="label_image" accept="image/*">
          <div class="form-text">Formats acceptés : JPG, PNG, WebP. Taille max recommandée : 5 Mo.</div>
        </div>
        <div class="col-md-4">
          <div id="image-preview" class="text-center" style="display: none;">
            <img id="preview-img" src="" alt="Aperçu" class="img-thumbnail" style="max-height: 150px;">
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-3 mb-3">
      <label class="form-label">Quantité</label>
      <input type="number" class="form-control" name="quantity" min="1" value="{{ form_data.get('quantity', '1') }}" required>
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Code-barres</label>
      <div class="input-group">
        <input type="text" class="form-control" id="barcode" name="barcode" placeholder="EAN/UPC" value="{{ form_data.get('barcode', '') }}">
        <button type="button" class="btn btn-outline-secondary" id="scan-btn">Scanner</button>
      </div>
    </div>
  </div>
  <div id="scanner-container" class="my-3" style="display:none;">
    <div class="ratio ratio-4x3 border rounded">
      <div id="scanner" class="w-100 h-100"></div>
    </div>
    <div class="form-text">Pointez la caméra arrière sur l'étiquette/code-barres.</div>
  </div>
  <button type="submit" class="btn btn-dark w-100">Sauvegarder</button>
</form>

<script>
(function() {
  const fieldSettings = {{ field_settings|tojson }};
  function updateFieldVisibility() {
    const select = document.getElementById('subcategory_id');
    const key = (select && select.value) ? select.value : 'default';
    const config = fieldSettings[key] || fieldSettings['default'];
    document.querySelectorAll('[data-field]').forEach((container) => {
      const fieldName = container.getAttribute('data-field');
      const settings = config[fieldName];
      const isEnabled = settings ? settings.enabled : true;
      const isRequired = settings ? settings.required : false;
      container.classList.toggle('d-none', !isEnabled);
      container.querySelectorAll('input, textarea, select').forEach((input) => {
        input.required = !!(isEnabled && isRequired);
      });
    });
  }

  function setupImagePreview() {
    const imageInput = document.getElementById('label_image');
    const previewContainer = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    
    if (imageInput && previewContainer && previewImg) {
      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewContainer.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          previewContainer.style.display = 'none';
          previewImg.src = '';
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('subcategory_id');
    if (select) {
      select.addEventListener('change', updateFieldVisibility);
    }
    updateFieldVisibility();
    setupImagePreview();
  });
})();
</script>
{% endblock %}
